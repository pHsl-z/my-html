<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>在线HTML5编辑器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* 允许编辑器内容可选 */
        .code-editor, .preview-frame {
            -webkit-user-select: text;
            user-select: text;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
            -webkit-text-size-adjust: 100%;
            /* 防止 iOS Safari 地址栏收起时的跳动 */
            min-height: -webkit-fill-available;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        :root {
            --vh: 1vh;
        }

        .container {
            display: flex;
            height: 100vh; /* 回退值 */
            height: calc(var(--vh, 1vh) * 100); /* 使用计算的视口高度 */
            width: 100vw;
            background: #161616;
            border: 1px solid #2a2a2a;
            margin: 0;
            overflow: hidden;
            position: relative;
            /* 防止 iOS 橡皮筋效果 */
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
        }

        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border-right: 1px solid #2a2a2a;
            min-width: 0;
            position: relative;
        }

        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            min-width: 0;
            position: relative;
        }

        .panel-header {
            background: #1a1a1a;
            color: #ffffff;
            padding: 16px 24px;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2a2a2a;
            letter-spacing: 0.5px;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .panel-title .btn-link {
            background: none;
            border: none;
            color: inherit;
            font: inherit;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            transition: opacity 0.2s ease;
        }
        
        .panel-title .btn-link:hover {
            opacity: 0.8;
        }
        
        .panel-title .btn-link:active {
            opacity: 0.6;
        }

        .code-editor {
            flex: 1;
            border: none;
            padding: 24px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
            background: #0d0d0d;
            color: #e6e6e6;
            caret-color: #ffffff;
            overflow-y: auto;
            overflow-x: auto;
            white-space: pre;
            tab-size: 4;
            -webkit-overflow-scrolling: touch;
            -webkit-appearance: none;
            appearance: none;
            border-radius: 0;
        }

        /* iOS Safari 优化 */
        .code-editor:focus {
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .code-editor::placeholder {
            color: #666666;
        }

        .preview-frame {
            flex: 1;
            border: none;
            background: #ffffff;
            -webkit-overflow-scrolling: touch;
            /* iOS Safari滚动优化 */
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
            /* 确保内容可以滚动 */
            overflow: auto;
            /* 支持触摸滚动 */
            touch-action: pan-x pan-y;
        }

        /* 按钮触摸优化 - 针对iOS Edge */
        .btn {
            background: #2a2a2a;
            color: #ffffff;
            border: 1px solid #3a3a3a;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            -webkit-appearance: none;
            appearance: none;
        }

        .btn:hover {
            background: #3a3a3a;
            border-color: #4a4a3a;
        }

        .btn:active {
            background: #1a1a1a;
            transform: translateY(0);
            opacity: 0.8;
        }
        
        /* iOS Safari/Edge 特殊优化 */
        @supports (-webkit-touch-callout: none) {
            .btn {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
                -webkit-appearance: none;
                appearance: none;
                -webkit-user-select: none;
                user-select: none;
            }
            
            .btn:active {
                opacity: 0.7;
                transform: scale(0.98);
            }
            
            /* iOS按钮点击延迟修复 */
            .btn {
                cursor: pointer;
                -webkit-touch-callout: none;
            }
            
            /* 防止iOS双击缩放 */
            * {
                -webkit-touch-callout: none;
                -webkit-text-size-adjust: none;
            }
            
            /* iOS滚动优化 */
            .code-editor {
                -webkit-overflow-scrolling: touch;

            }
        }
        
        /* iOS 13+ 增强兼容性 */
        @media (pointer: coarse) {
            .btn {
                min-height: 44px; /* iOS推荐的最小触摸目标 */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .btn-group {
                gap: 8px;
            }
        }

        .btn-primary {
            background: #0066ff;
            border-color: #0066ff;
        }

        .btn-primary:hover {
            background: #0052cc;
            border-color: #0052cc;
        }

        .btn-secondary {
            background: #404040;
            border-color: #505050;
        }

        .btn-secondary:hover {
            background: #4a4a4a;
            border-color: #5a5a5a;
        }

        .btn-success {
            background: #00a86b;
            border-color: #00a86b;
        }

        .btn-success:hover {
            background: #008c5a;
            border-color: #008c5a;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            min-height: auto;
        }

        .btn-info {
            background: #17a2b8;
            border-color: #17a2b8;
        }

        .btn-info:hover {
            background: #138496;
            border-color: #138496;
        }

        /* 下拉菜单样式 */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            background: transparent !important;
            border: none !important;
            color: #ffffff !important;
            padding: 8px 12px !important;
            font-size: 14px !important;
            font-weight: 500 !important;
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
            transition: all 0.2s ease !important;
        }

        .dropdown-toggle:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-radius: 4px !important;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            min-width: 120px;
            display: none;
            margin-top: 4px;
            padding: 4px 0;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            background: transparent !important;
            border: none !important;
            color: #ffffff !important;
            padding: 8px 16px !important;
            font-size: 13px !important;
            font-weight: 400 !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            width: 100% !important;
            text-align: left !important;
            transition: all 0.2s ease !important;
            cursor: pointer !important;
            border-radius: 0 !important;
            min-height: auto !important;
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        .dropdown-item .icon {
            font-size: 14px !important;
            width: 16px !important;
            text-align: center !important;
        }

        /* 全屏预览样式 */
        .fullscreen-preview {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            background: white !important;
            margin: 0 !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        .fullscreen-preview .panel-header {
            display: none !important;
        }

        .fullscreen-preview .panel-title,
        .fullscreen-preview .btn-group {
            display: none !important;
        }

        .fullscreen-preview .preview-frame {
            width: 100% !important;
            height: 100% !important;
            border: none !important;
        }

        /* 自定义关闭按钮 */
        .fullscreen-close {
            position: fixed !important;
            top: 16px !important;
            right: 16px !important;
            width: 32px !important;
            height: 32px !important;
            z-index: 10000 !important;
            background: rgba(0, 0, 0, 0.2) !important;
            border: none !important;
            border-radius: 50% !important;
            cursor: pointer !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            opacity: 0.3 !important;
            transition: all 0.2s ease !important;
            padding: 0 !important;
            outline: none !important;
        }

        .fullscreen-close:hover {
            opacity: 0.6 !important;
            background: rgba(0, 0, 0, 0.3) !important;
        }

        .fullscreen-close::before,
        .fullscreen-close::after {
            content: '' !important;
            position: absolute !important;
            width: 16px !important;
            height: 1.5px !important;
            background: white !important;
            transform-origin: center !important;
        }

        .fullscreen-close::before {
            transform: rotate(45deg) !important;
        }

        .fullscreen-close::after {
            transform: rotate(-45deg) !important;
        }
        
        /* iPhone关闭按钮触摸优化 */
        @media (max-width: 414px) {
            .fullscreen-close {
                top: 12px !important;
                right: 12px !important;
                width: 44px !important; /* iOS推荐触摸目标 */
                height: 44px !important;
                opacity: 0.5 !important;
                background: rgba(0, 0, 0, 0.4) !important;
                border: 2px solid rgba(255, 255, 255, 0.3) !important;
            }
            
            .fullscreen-close:hover {
                opacity: 0.8 !important;
                background: rgba(0, 0, 0, 0.6) !important;
            }
            
            .fullscreen-close::before,
            .fullscreen-close::after {
                width: 20px !important;
                height: 2px !important;
            }
        }
        
        /* iPhone面板关闭按钮优化 */
        @media (max-width: 414px) {
            .modal-header .btn-secondary {
                min-width: 44px !important;
                min-height: 44px !important;
                padding: 8px 12px !important;
                font-size: 16px !important;
                border-radius: 8px !important;
                -webkit-tap-highlight-color: transparent !important;
            }
            
            .modal-header .btn-secondary:active {
                background-color: #6c757d !important;
                transform: scale(0.95) !important;
            }
        }
        
        /* iPhone历史记录删除按钮优化 */
        @media (max-width: 414px) {
            .history-item .btn-outline-danger {
                min-width: 44px !important;
                min-height: 44px !important;
                padding: 6px 10px !important;
                font-size: 14px !important;
                border-radius: 8px !important;
                -webkit-tap-highlight-color: transparent !important;
            }
            
            .history-item .btn-outline-danger:active {
                background-color: #dc3545 !important;
                color: white !important;
                transform: scale(0.95) !important;
            }
        }
        


        .btn-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-bar {
            background: #0d0d0d;
            color: #888888;
            padding: 8px 24px;
            font-size: 12px;
            border-top: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #00a86b;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        /* 滚动条样式 */
        .code-editor::-webkit-scrollbar {
            width: 8px;
        }

        .code-editor::-webkit-scrollbar-track {
            background: #0d0d0d;
        }

        .code-editor::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }

        .code-editor::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }

        /* 移动设备优化 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .editor-panel {
                border-right: none;
                border-bottom: 1px solid #2a2a2a;
                flex: 0 0 50%;
                min-height: 200px;
            }
            
            .preview-panel {
                flex: 1;
                min-height: 200px;
            }

            .panel-header {
                padding: 10px 12px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .panel-title {
                flex-shrink: 0;
            }

            .btn-group {
                gap: 6px;
                margin-left: auto;
                flex-shrink: 0;
                justify-content: flex-end;
            }

            .code-editor {
                padding: 12px;
                font-size: 13px;
                line-height: 1.5;
            }
            
            .button {
                padding: 6px 10px;
                font-size: 12px;
                min-height: 36px;
            }
            
            .status-bar {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            .char-count {
                font-size: 11px;
            }
            
            /* 移动设备通知位置（代码面板内，靠左上，下滑） */
            .editor-panel .toast {
                top: 56px;
                left: 50%; /* 强制居中 */
                transform: translate(-50%, -10px);
                max-width: calc(100% - 20px);
                font-size: 13px;
                padding: 10px 15px;
            }
            
            /* iPhone关闭按钮优化 */
            @media (max-width: 414px) {
                .history-panel,
                .share-panel,
                .settings-panel {
                    border-radius: 16px 16px 0 0 !important;
                    margin: 0 8px !important;
                    max-height: 90vh !important; /* 增加最大高度 */
                    bottom: 0 !important;
                    top: auto !important;
                    left: 8px !important;
                    right: 8px !important;
                    width: auto !important;
                    transform: translateY(100%) !important;
                    transition: transform 0.3s ease-out !important;
                }
                
                .history-panel.show,
                .share-panel.show,
                .settings-panel.show {
                    transform: translateY(0) !important;
                }
                
                .history-header,
                .share-header,
                .settings-header {
                    padding: 12px 16px !important; /* 减少头部内边距 */
                    border-radius: 16px 16px 0 0 !important;
                    position: sticky !important;
                    top: 0 !important;
                    background: #1a1a1a !important;
                    z-index: 10 !important;
                    border-bottom: 1px solid #2a2a2a !important;
                }
                
                .history-header > div,
                .share-header > div,
                .settings-header > div {
                    gap: 8px !important; /* 减少按钮间距 */
                }
                
                .btn-sm {
                    padding: 6px 12px !important; /* 减小按钮内边距 */
                    font-size: 13px !important; /* 减小字体大小 */
                    min-height: 36px !important; /* 减小按钮高度 */
                    border-radius: 6px !important;
                }
                
                /* 分享面板特殊优化 */
                .share-panel .share-content {
                    padding: 16px !important; /* 减少内容内边距 */
                    max-height: calc(90vh - 60px) !important; /* 重新计算最大高度 */
                }
                
                .share-panel .share-description {
                    font-size: 13px !important; /* 减小描述文字 */
                    margin-bottom: 12px !important; /* 减少间距 */
                }
                
                .share-panel .share-link-container {
                    margin-bottom: 16px !important; /* 减少间距 */
                }
                
                .share-panel .share-link-input {
                    font-size: 12px !important; /* 减小输入框字体 */
                    padding: 8px 10px !important; /* 减少输入框内边距 */
                }
                
                .share-panel .share-actions {
                    margin-bottom: 16px !important; /* 减少间距 */
                    gap: 6px !important; /* 减少按钮间距 */
                }
                
                .share-panel .share-history-section {
                    margin-bottom: 16px !important; /* 减少间距 */
                    padding: 12px !important; /* 减少历史区域内边距 */
                }
                
                .share-panel .share-history-list {
                    max-height: 150px !important; /* 减少历史列表高度 */
                }
                
                /* 面板内容区域 */
                .history-list,
                .settings-content {
                    padding: 16px !important; /* 减少通用内容内边距 */
                    max-height: calc(90vh - 60px) !important; /* 重新计算最大高度 */
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch !important;
                }
                

            }
        }

        /* 平板设备优化 */
        @media (min-width: 769px) and (max-width: 1024px) {
            .button {
                padding: 7px 12px;
                font-size: 12px;
            }
            
            .code-editor {
                font-size: 13px;
                padding: 15px;
            }
            
            .panel-header {
                padding: 14px 18px;
            }
            
            /* iPad竖屏通知优化（代码面板内） */
            @media (orientation: portrait) {
                .editor-panel .toast {
                    top: 64px;
                    left: 50%; /* 竖屏也保持居中 */
                    transform: translate(-50%, -10px);
                    max-width: min(280px, calc(100% - 32px));
                    font-size: 13px;
                }
            }
        }

        /* 桌面设备优化 */
        @media (min-width: 1025px) {
            .container {
                max-width: 100vw;
                margin: 0 auto;
            }
        }

        /* iPad横屏特殊优化 */
        @media (min-width: 1024px) and (max-width: 1366px) and (orientation: landscape) {
            /* iPad Pro横屏通知（代码面板内） */
            .editor-panel .toast {
                top: 64px;
                left: 50%; /* 横屏保持居中 */
                transform: translate(-50%, -10px);
                max-width: min(350px, calc(100% - 48px));
                font-size: 14px;
            }
        }
        
        @media (min-width: 768px) and (max-width: 1023px) and (orientation: landscape) {
            /* iPad横屏通知（代码面板内） */
            .editor-panel .toast {
                top: 64px;
                left: 50%; /* 横屏保持居中 */
                transform: translate(-50%, -10px);
                max-width: min(320px, calc(100% - 40px));
                font-size: 13px;
            }
        }

        /* 全屏预览优化 */
        .fullscreen-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: #1a1a1a;
            margin: 0;
            border: none;
            border-radius: 0;
        }

        .fullscreen-preview .panel-header {
            padding: 12px 20px;
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fullscreen-preview .panel-title {
            font-size: 16px;
            font-weight: 500;
        }

        .fullscreen-preview .preview-frame {
            height: calc(100vh - 60px);
            width: 100%;
            border: none;
            background: white;
        }

        .fullscreen-preview .btn {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #3a3a3a;
            background: #2a2a2a;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .fullscreen-preview .btn:hover {
            background: #3a3a3a;
            border-color: #4a4a4a;
        }

        /* 超小屏幕优化 */
        @media (max-width: 480px) {
            .panel-header {
                padding: 8px 10px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: nowrap;
                gap: 8px;
            }

            .panel-title {
                font-size: 14px;
                flex-shrink: 0;
            }

            .btn-group {
                gap: 4px;
                margin-left: auto;
                flex-shrink: 0;
            }

            .button, .btn {
                padding: 5px 8px;
                font-size: 11px;
                min-height: 32px;
            }

            .code-editor {
                padding: 10px;
                font-size: 12px;
            }

            .status-bar {
                padding: 5px 10px;
                font-size: 10px;
            }

            .fullscreen-preview .panel-header {
                padding: 10px 15px;
            }

            .fullscreen-preview .btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            /* 超小屏幕通知（代码面板内） */
            .editor-panel .toast {
                top: 52px; /* 更贴近顶部 */
                left: 50%; /* 居中 */
                transform: translate(-50%, -10px);
                max-width: calc(100% - 16px);
                width: auto;
                font-size: 12px;
                padding: 8px 12px;
                border-radius: 6px;
            }
        }

        /* 平板横屏优化 */
        @media (min-width: 769px) and (max-width: 1024px) and (orientation: landscape) {
            .container {
                flex-direction: row;
            }
            
            .editor-panel {
                flex: 0 0 45%;
                border-right: 1px solid #2a2a2a;
                border-bottom: none;
            }
            
            .preview-panel {
                flex: 1;
            }
            
            /* iPad横屏通知优化 - 避免遮挡顶部按钮（代码面板内） */
            .editor-panel .toast {
                top: 70px; /* 增加顶部距离，避免遮挡面板标题 */
                left: 50%;
                transform: translate(-50%, -10px);
                max-width: 300px;
            }
        }

        /* 全屏预览移动设备优化 */
        @media (max-width: 768px) and (orientation: portrait) {
            .fullscreen-preview .panel-header {
                padding: 10px 15px;
                display: flex;
                justify-content: flex-end;
                align-items: center;
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(0,0,0,0.8);
                border-radius: 8px;
                left: auto;
                width: auto;
            }
            
            .fullscreen-preview .preview-frame {
                height: calc(100vh - 50px);
            }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            .fullscreen-preview .panel-header {
                padding: 8px 12px;
                display: flex;
                justify-content: flex-end;
                align-items: center;
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(0,0,0,0.8);
                border-radius: 8px;
                left: auto;
                width: auto;
            }
            
            .fullscreen-preview .preview-frame {
                height: calc(100vh - 45px);
            }
        }

        /* 粘贴按钮动画 */
        .paste-btn.pasting {
            animation: pastePulse 0.6s ease;
        }

        @keyframes pastePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background: #00a86b; }
            100% { transform: scale(1); }
        }

        /* 消息提示样式：放在代码面板内，从上向下滑入 */
        .editor-panel .toast {
            position: absolute;
            top: 64px; /* 位于编辑器面板标题下方，紧贴代码框顶部 */
            left: 50%; /* 顶部居中 */
            transform: translate(-50%, -12px); /* 初始比代码框顶部略高一些 */
            background: rgba(30, 30, 30, 0.95);
            color: #ffffff;
            border: 1px solid #3a3a3a;
            border-radius: 10px;
            padding: 12px 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.03);
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: transform 0.25s ease, opacity 0.25s ease;
            max-width: min(360px, calc(100% - 32px));
            width: auto;
        }

        .editor-panel .toast.show {
            transform: translate(-50%, 20px); /* 下移更多，完全进入代码框内 */
            opacity: 1;
        }

        .toast.success {
            border-color: #00a86b;
            background: rgba(0, 168, 107, 0.1);
        }

        .toast.error {
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }

        /* 历史记录面板样式 */
        .history-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 300px;
            background: #1a1a1a;
            border-top: 1px solid #2a2a2a;
            display: none;
            flex-direction: column;
            z-index: 100;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
        }

        .history-panel.show {
            display: flex;
        }

        .history-header {
            padding: 12px 20px;
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 500;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .history-item {
            padding: 12px 20px;
            border-bottom: 1px solid #2a2a2a;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 13px;
        }

        .history-item:hover {
            background: #2a2a2a;
        }

        .history-item:active {
            background: #1a1a1a;
        }

        .history-item-content {
            color: #e6e6e6;
            margin-bottom: 8px;
            word-break: break-all;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-info {
            color: #888888;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item-delete {
            background: none;
            border: none;
            color: #888888;
            cursor: pointer;
            font-size: 12px;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .history-item-delete:hover {
            background: #3a3a3a;
            color: #ff4757;
        }

        /* 历史记录面板滚动条样式 */
        .history-list::-webkit-scrollbar {
            width: 8px;
        }

        .history-list::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }

        .history-list::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }

        /* 空历史记录提示 */
        .history-empty {
            padding: 40px 20px;
            text-align: center;
            color: #888888;
            font-size: 14px;
        }

        /* 分享面板样式 */
        .share-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 400px;
            background: #1a1a1a;
            border-top: 1px solid #2a2a2a;
            display: none;
            flex-direction: column;
            z-index: 101;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* 移动端分享面板优化 - 确保重要内容优先显示 */
        @media (max-width: 480px) {
            .share-panel {
                max-height: 85vh !important; /* 进一步增加高度 */
            }
            
            .share-panel .share-content {
                display: flex !important;
                flex-direction: column !important;
                max-height: calc(85vh - 50px) !important; /* 重新计算 */
            }
            
            /* 重要内容优先显示 - 分享链接部分 */
            .share-panel .share-description {
                order: 1 !important;
                margin-bottom: 8px !important; /* 进一步减少间距 */
                font-size: 12px !important;
            }
            
            .share-panel .share-link-container {
                order: 2 !important;
                margin-bottom: 12px !important;
                flex-shrink: 0 !important; /* 防止被压缩 */
            }
            
            .share-panel .share-actions {
                order: 3 !important;
                margin-bottom: 12px !important;
                flex-shrink: 0 !important;
            }
            
            /* 次要内容放在后面 */
            .share-panel .share-history-section {
                order: 4 !important;
                flex: 1 !important; /* 占据剩余空间 */
                overflow-y: auto !important;
                margin-bottom: 0 !important;
            }
            
            .share-panel .share-tips {
                order: 5 !important;
                margin-top: 12px !important;
                padding-top: 12px !important;
                border-top: 1px solid #3a3a3a !important;
            }
            
            /* 进一步优化链接输入框 */
            .share-panel .share-link-input {
                font-size: 11px !important;
                padding: 6px 8px !important;
                min-height: 32px !important;
            }
            
            .share-panel .share-actions .btn {
                padding: 4px 8px !important;
                font-size: 11px !important;
                min-height: 28px !important;
            }
            
            /* 隐藏分享提示在小屏幕上 */
            .share-panel .share-tips h4 {
                font-size: 12px !important;
                margin-bottom: 6px !important;
            }
            
            .share-panel .share-tips ul {
                font-size: 11px !important;
                padding-left: 16px !important;
            }
            
            .share-panel .share-tips li {
                margin-bottom: 2px !important;
                line-height: 1.4 !important;
            }
        }

        .share-panel.show {
            display: flex;
        }

        .share-header {
            padding: 12px 20px;
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 500;
        }

        .share-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .share-description {
            color: #e6e6e6;
            margin-bottom: 16px;
            font-size: 14px;
            line-height: 1.6;
        }

        .share-link-container {
            display: flex;
            margin-bottom: 20px;
            gap: 8px;
            align-items: center;
        }

        .share-link-input {
            flex: 1;
            padding: 10px 12px;
            background: #0d0d0d;
            border: 1px solid #2a2a2a;
            color: #e6e6e6;
            font-size: 13px;
            border-radius: 4px;
            outline: none;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        }

        .share-link-input:focus {
            border-color: #0066ff;
        }

        .share-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        /* 分享历史样式 */
        .share-history-section {
            margin-bottom: 20px;
            padding: 16px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }

        .share-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .share-history-header h4 {
            color: #e6e6e6;
            margin: 0;
            font-size: 14px;
            font-weight: 500;
        }

        .share-history-actions {
            display: flex;
            gap: 8px;
        }

        .share-history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .share-history-item {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }

        .share-history-item:hover {
            background: #252525;
        }

        .share-history-info {
            flex: 1;
            margin-right: 12px;
        }

        .share-history-title {
            color: #e6e6e6;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .share-history-meta {
            color: #888888;
            font-size: 11px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .share-history-provider {
            background: #0066ff;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
        }

        .share-history-actions-item {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .share-history-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .share-history-btn-copy {
            background: #0066ff;
            color: white;
        }

        .share-history-btn-copy:hover {
            background: #0052cc;
        }

        .share-history-btn-open {
            background: #28a745;
            color: white;
        }

        .share-history-btn-open:hover {
            background: #218838;
        }

        .share-history-btn-delete {
            background: #dc3545;
            color: white;
        }

        .share-history-btn-delete:hover {
            background: #c82333;
        }

        .no-history {
            color: #888888;
            font-size: 13px;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }

        .share-tips {
            background: #2a2a2a;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #0066ff;
        }

        .share-tips h4 {
            color: #e6e6e6;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 500;
        }

        .share-tips ul {
            list-style-type: disc;
            list-style-position: inside;
            color: #888888;
            font-size: 13px;
        }

        .share-tips li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        /* 分享面板滚动条样式 */
        .share-content::-webkit-scrollbar {
            width: 8px;
        }

        .share-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .share-content::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }

        .share-content::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }

        /* 移动设备适配 */
        @media (max-width: 768px) {
            .share-content {
                padding: 12px;
            }
            
            .share-link-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .share-actions {
                flex-direction: column;
            }
            
            .share-tips {
                padding: 12px;
            }
            
            .share-history-section {
                padding: 12px;
            }
            
            .share-history-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .share-history-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .share-history-item {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .share-history-actions-item {
                justify-content: flex-end;
            }
            
            .share-history-btn {
                font-size: 10px;
                padding: 6px 10px;
            }
        }

        /* 弹出式窗口基础样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-container {
            background: #1a1a1a;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            max-width: 90vw;
            max-height: 90vh;
            width: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #3a3a3a;
        }

        .modal-header {
            padding: 16px 20px;
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            font-weight: 500;
        }

        .modal-title {
            color: #e6e6e6;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888888;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            color: #e6e6e6;
            background: #3a3a3a;
        }

        .modal-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* 移动端弹窗适配 */
        @media (max-width: 768px) {
            .modal-container {
                width: 95vw;
                max-height: 85vh;
                margin: 20px;
                border-radius: 8px;
            }
            
            .modal-header {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .modal-content {
                padding: 16px;
            }
        }

        @media (max-width: 480px) {
            .modal-container {
                width: 100vw;
                max-height: 100vh;
                margin: 0;
                border-radius: 0;
                border: none;
            }
            
            .modal-header {
                padding: 12px 16px;
            }
            
            .modal-content {
                padding: 12px;
            }
        }

        /* 设置面板样式 */
        .settings-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 450px;
            background: #1a1a1a;
            border-top: 1px solid #2a2a2a;
            display: none;
            flex-direction: column;
            z-index: 102;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
        }

        .settings-panel.show {
            display: flex;
        }

        .settings-header {
            padding: 12px 20px;
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 500;
        }

        .settings-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .settings-section {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #2a2a2a;
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 20px;
            padding-bottom: 0;
        }

        .settings-section h4 {
            color: #e6e6e6;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 500;
        }

        .setting-item {
            margin-bottom: 16px;
        }

        .setting-label {
            display: block;
            color: #e6e6e6;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .setting-control {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .setting-input {
            padding: 8px 12px;
            background: #0d0d0d;
            border: 1px solid #2a2a2a;
            color: #e6e6e6;
            font-size: 13px;
            border-radius: 4px;
            outline: none;
            min-width: 200px;
        }

        .setting-input:focus {
            border-color: #0066ff;
        }

        .setting-input[type="number"] {
            min-width: 80px;
            width: 80px;
        }

        .setting-description {
            color: #888888;
            font-size: 11px;
            line-height: 1.5;
            margin: 0;
        }

        .settings-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* 设置面板滚动条样式 */
        .settings-content::-webkit-scrollbar {
            width: 8px;
        }

        .settings-content::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .settings-content::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 4px;
        }

        .settings-content::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }

        /* 移动设备适配 */
        @media (max-width: 768px) {
            .settings-content {
                padding: 12px;
            }
            
            .settings-control {
                flex-direction: column;
                align-items: stretch;
            }
            
            .setting-input {
                min-width: auto;
            }
            
            .settings-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="editor-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <button class="btn btn-link" onclick="showHelp()" style="background: none; border: none; color: inherit; font: inherit; cursor: pointer; padding: 0; display: flex; align-items: center;" type="button">
                        <span>⚡</span>
                        <span style="margin-left: 8px;">HTML EDITOR</span>
                    </button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="openLocalFile()" id="openBtn" type="button">
                        <span class="icon">📁</span>
                        打开
                    </button>
                    <button class="btn btn-secondary" onclick="clearEditor()" id="clearBtn" type="button">
                        <span class="icon">🗑️</span>
                        清空
                    </button>
                    <button class="btn btn-secondary" onclick="pasteFromClipboard()" id="pasteBtn" type="button">
                        <span class="icon">📋</span>
                        粘贴
                    </button>
                    <!-- 历史、分享、设置按钮已移动到预览面板的下拉菜单中 -->
                </div>
            </div>
            <textarea id="htmlEditor" class="code-editor" placeholder="在这里输入你的HTML代码，或者点击粘贴按钮从剪贴板导入..."></textarea>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>实时预览</span>
                </div>
                <div>
                    <span id="charCount">0</span> 字符
                </div>
            </div>
            
            <!-- 历史记录面板 -->
            <div id="historyPanel" class="history-panel">
                <div class="history-header">
                    <span>📋 历史记录</span>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-danger" onclick="clearHistory()">清空历史</button>
                        <button class="btn btn-sm btn-secondary" onclick="closeAllPanels()">关闭</button>
                    </div>
                </div>
                <div id="historyList" class="history-list"></div>
            </div>
            
            <!-- 分享面板 -->
            <div id="sharePanel" class="share-panel">
                <div class="share-header">
                    <span>🔗 分享链接</span>
                    <button class="btn btn-sm btn-secondary" onclick="closeAllPanels()">关闭</button>
                </div>
                <div class="share-content">
                    <p class="share-description">生成一个可分享的链接，其他人可以通过该链接查看和编辑当前内容：</p>
                    <div class="share-link-container">
                        <input type="text" id="shareLink" class="share-link-input" readonly>
                        <button class="btn btn-sm btn-primary" onclick="copyShareLink()">复制链接</button>
                    </div>
                    <div class="share-actions">
                        <button class="btn btn-secondary" onclick="generateShareLink()">重新生成</button>
                        <button class="btn btn-success" onclick="openShareLink()">在新窗口打开</button>
                        <button class="btn btn-primary" onclick="generateOnlineLink()">自动生成在线链接</button>
                    </div>
                    
                    <!-- 分享历史管理 -->
                    <div class="share-history-section">
                        <div class="share-history-header">
                            <h4>📚 分享历史</h4>
                            <div class="share-history-actions">
                                <button class="btn btn-sm btn-secondary" onclick="refreshShareHistory()">刷新</button>
                                <button class="btn btn-sm btn-danger" onclick="clearShareHistory()">清空历史</button>
                            </div>
                        </div>
                        <div id="shareHistoryList" class="share-history-list">
                            <p class="no-history">暂无分享历史</p>
                        </div>
                    </div>
                    
                    <div class="share-tips">
                        <h4>💡 分享提示：</h4>
                        <ul>
                            <li>链接包含了当前编辑器的所有内容</li>
                            <li>链接可以被任何人访问和修改</li>
                            <li>新压缩算法可显著减少链接长度</li>
                            <li>刷新页面后链接仍然有效</li>
                            <li>可在设置中自定义分享链接的基础URL</li>
                            <li>分享历史会自动保存，方便管理之前的分享</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 设置面板 -->
            <div id="settingsPanel" class="settings-panel">
                <div class="settings-header">
                    <span>⚙️ 编辑器设置</span>
                    <button class="btn btn-sm btn-secondary" onclick="closeAllPanels()">关闭</button>
                </div>
                <div class="settings-content">
                    <div class="settings-section">
                        <h4>🔗 分享设置</h4>
                        <div class="setting-item">
                            <label for="shareBaseUrl" class="setting-label">分享链接基础URL：</label>
                            <div class="setting-control">
                                <input type="text" id="shareBaseUrl" class="setting-input" placeholder="例如：https://example.com/editor.html">
                                <button class="btn btn-sm btn-primary" onclick="saveShareBaseUrl()">保存</button>
                                <button class="btn btn-sm btn-secondary" onclick="resetShareBaseUrl()">重置</button>
                            </div>
                            <p class="setting-description">设置用于生成分享链接的基础URL，默认使用当前页面URL。</p>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>💾 自动保存</h4>
                        <div class="setting-item">
                            <label for="autoSaveInterval" class="setting-label">自动保存间隔（秒）：</label>
                            <div class="setting-control">
                                <input type="number" id="autoSaveInterval" class="setting-input" min="1" max="600" value="10">
                                <button class="btn btn-sm btn-primary" onclick="saveAutoSaveInterval()">保存</button>
                            </div>
                            <p class="setting-description">设置编辑器自动保存内容的时间间隔。</p>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>📝 历史记录</h4>
                        <div class="setting-item">
                            <label for="maxHistoryRecords" class="setting-label">最大历史记录数：</label>
                            <div class="setting-control">
                                <input type="number" id="maxHistoryRecords" class="setting-input" min="1" max="50" value="10">
                                <button class="btn btn-sm btn-primary" onclick="saveMaxHistoryRecords()">保存</button>
                            </div>
                            <p class="setting-description">设置编辑器保存的最大历史记录数量。</p>
                        </div>
                    </div>
                    
                    <div class="settings-actions">
                        <button class="btn btn-primary" onclick="applyAllSettings()">应用所有设置</button>
                        <button class="btn btn-secondary" onclick="loadSettings()">重新加载设置</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="preview-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle" onclick="togglePreviewDropdown()" id="previewDropdownBtn" type="button">
                            <span>👁️</span>
                            <span style="margin-left: 8px;">预览</span>
                            <span style="margin-left: 4px;">▼</span>
                        </button>
                        <div class="dropdown-menu" id="previewDropdownMenu">
                            <button class="btn btn-secondary dropdown-item" onclick="toggleHistoryPanel()" id="historyBtn">
                                <span class="icon">🕒</span>
                                历史
                            </button>
                            <button class="btn btn-primary dropdown-item" onclick="toggleSharePanel()" id="shareBtn">
                                <span class="icon">🔗</span>
                                分享
                            </button>
                            <button class="btn btn-info dropdown-item" onclick="toggleSettingsPanel()" id="settingsBtn">
                                <span class="icon">⚙️</span>
                                设置
                            </button>
                        </div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="toggleFullscreenPreview()" id="fullscreenBtn">
                        <span class="icon">⛶</span>
                        全屏
                    </button>
                    <button class="btn btn-secondary" onclick="printPreview()" id="printBtn">
                        <span class="icon">🖨️</span>
                        打印
                    </button>
                    <button class="btn btn-primary" onclick="downloadHTML()" id="downloadBtn">
                        <span class="icon">💾</span>
                        下载
                    </button>
                </div>
            </div>
            <iframe id="previewFrame" class="preview-frame"></iframe>
        </div>
    </div>

    <!-- 弹出式窗口遮罩层 -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalTitle" class="modal-title">标题</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent" class="modal-content">
                <!-- 动态内容将在这里插入 -->
            </div>
        </div>
    </div>

    <!-- 隐藏的文件输入元素 -->
    <input type="file" id="fileInput" accept=".html,.htm" style="display: none;">

    <script>
        const htmlEditor = document.getElementById('htmlEditor');
        const previewFrame = document.getElementById('previewFrame');
        const charCount = document.getElementById('charCount');
        const pasteBtn = document.getElementById('pasteBtn');
        const clearBtn = document.getElementById('clearBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const openBtn = document.getElementById('openBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const printBtn = document.getElementById('printBtn');
        const historyBtn = document.getElementById('historyBtn');
        const shareBtn = document.getElementById('shareBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const fileInput = document.getElementById('fileInput');
        const historyPanel = document.getElementById('historyPanel');
        const historyList = document.getElementById('historyList');
        const sharePanel = document.getElementById('sharePanel');
        const shareLink = document.getElementById('shareLink');
        const settingsPanel = document.getElementById('settingsPanel');
        const shareBaseUrlInput = document.getElementById('shareBaseUrl');
        const autoSaveIntervalInput = document.getElementById('autoSaveInterval');
        const maxHistoryRecordsInput = document.getElementById('maxHistoryRecords');
        
        // 历史记录相关变量
        let historyRecords = [];
        let MAX_HISTORY_RECORDS = 10;
        const HISTORY_STORAGE_KEY = 'htmlEditorHistory';
        
        // 分享相关变量
        const SHARE_PARAM_NAME = 'content';
        let shareBaseUrl = '';
        
        // 自动保存相关变量
        let autoSaveInterval = 10;
        const SETTINGS_STORAGE_KEY = 'htmlEditorSettings';

        // 默认HTML模板 - 针对移动设备优化
        const defaultHTML = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的HTML5页面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 30px 20px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        
        h1 {
            color: #1d1d1f;
            margin-bottom: 20px;
            font-size: 28px;
            font-weight: 600;
            text-align: center;
        }
        
        p {
            color: #86868b;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .feature {
            background: #f5f5f7;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
        }
        
        .feature h3 {
            color: #1d1d1f;
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .feature p {
            color: #86868b;
            font-size: 14px;
            margin: 0;
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px 15px;
                border-radius: 12px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            p {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎉 欢迎使用HTML5编辑器</h1>
        <p>这是一个响应式的HTML5页面模板，完美适配iOS、Android、macOS和Windows设备。</p>
        
        <div class="feature">
            <h3>📱 移动优先</h3>
            <p>在各种移动设备上都有出色的显示效果</p>
        </div>
        
        <div class="feature">
            <h3>💻 跨平台兼容</h3>
            <p>支持iOS、Android、macOS、Windows等主流平台</p>
        </div>
        
        <div class="feature">
            <h3>🚀 性能优化</h3>
            <p>快速加载，流畅的用户体验</p>
        </div>
    </div>
</body>
</html>`;

        // 初始化编辑器 - 修改为清空状态
        htmlEditor.value = '';
        updateCharCount();
        
        // IE浏览器兼容性：确保iframe正确初始化
        if (document.documentMode || /Edge/.test(navigator.userAgent)) {
            previewFrame.style.display = 'block';
            previewFrame.style.width = '100%';
            previewFrame.style.height = 'calc(100% - 60px)';
        }
        
        // 延迟初始化预览，确保DOM完全加载
        setTimeout(function() {
            updatePreview();
        }, 100);

        // 实时预览功能 - 优化触摸设备体验
        let updateTimeout;
        htmlEditor.addEventListener('input', function() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(updatePreview, 100);
            updateCharCount();
        });
        
        // iOS Edge浏览器兼容性：监听change事件
        htmlEditor.addEventListener('change', function() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(updatePreview, 100);
            updateCharCount();
        });
        
        // IE浏览器兼容性：监听propertychange事件
        if (document.documentMode || /Edge/.test(navigator.userAgent)) {
            htmlEditor.addEventListener('propertychange', function(e) {
                if (e.propertyName === 'value') {
                    clearTimeout(updateTimeout);
                    updateTimeout = setTimeout(updatePreview, 100);
                    updateCharCount();
                }
            });
        }
        
        // 监听keyup事件以确保IE兼容性
        htmlEditor.addEventListener('keyup', function() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(updatePreview, 100);
            updateCharCount();
        });
        
        // 触摸设备优化 - 防止键盘遮挡
        let initialLoad = true;
        htmlEditor.addEventListener('focus', function() {
            // 首次加载时不执行滚动
            if (initialLoad) {
                initialLoad = false;
                return;
            }
            // 延迟滚动确保编辑器可见，仅在需要时执行
            if (document.activeElement === htmlEditor) {
                setTimeout(() => {
                    const rect = htmlEditor.getBoundingClientRect();
                    const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
                    if (!isVisible) {
                        htmlEditor.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 300);
            }
        });

        function updatePreview() {
            const code = htmlEditor.value;
            const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
            try {
                // 使用srcdoc属性避免重复声明问题（现代浏览器）
                if ('srcdoc' in previewFrame) {
                    previewFrame.srcdoc = code;
                } else {
                    // IE浏览器兼容性处理
                    if (previewDoc.open && previewDoc.write && previewDoc.close) {
                        previewDoc.open();
                        previewDoc.write(code);
                        previewDoc.close();
                    } else {
                        // 对于IE的备用方案
                        previewFrame.src = 'data:text/html;charset=utf-8,' + encodeURIComponent(code);
                    }
                }
                
                // 延迟应用滚动优化，确保内容完全加载
                setTimeout(() => {
                    enhancePreviewScrolling();
                }, 50);
            } catch (error) {
                console.log('Preview update error:', error);
                // IE浏览器备用方案
                try {
                    previewFrame.src = 'data:text/html;charset=utf-8,' + encodeURIComponent(code);
                } catch (ieError) {
                    console.log('IE preview fallback error:', ieError);
                }
            }
        }

        function refreshPreview() {
            updatePreview();
        }

        // 打开本地HTML文件
        function openLocalFile() {
            // 触发文件选择对话框
            fileInput.click();
        }

        // 处理文件选择
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            // 检查文件类型
            if (!file.name.toLowerCase().endsWith('.html') && !file.name.toLowerCase().endsWith('.htm')) {
                showToast('请选择HTML文件', 'error');
                return;
            }

            // 读取文件内容
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // 将文件内容显示在预览窗口中
                    displayFileInPreview(content);
                    
                    // 可选：将内容也加载到编辑器中
                    if (confirm('是否将文件内容加载到编辑器中？')) {
                        htmlEditor.value = content;
                        updateCharCount();
                    }
                    
                    showToast(`已打开文件: ${file.name}`, 'success');
                } catch (error) {
                    console.error('文件读取错误:', error);
                    showToast('文件读取失败，请重试', 'error');
                }
            };
            
            reader.onerror = function() {
                showToast('文件读取失败，请重试', 'error');
            };
            
            // 以文本形式读取文件
            reader.readAsText(file, 'UTF-8');
        });

        // 在预览窗口中显示文件内容
        function displayFileInPreview(content) {
            try {
                const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                
                // 使用srcdoc属性避免重复声明问题（现代浏览器）
                if ('srcdoc' in previewFrame) {
                    previewFrame.srcdoc = content;
                } else {
                    // IE浏览器兼容性处理
                    if (previewDoc.open && previewDoc.write && previewDoc.close) {
                        previewDoc.open();
                        previewDoc.write(content);
                        previewDoc.close();
                    } else {
                        // 对于IE的备用方案
                        previewFrame.src = 'data:text/html;charset=utf-8,' + encodeURIComponent(content);
                    }
                }
                
                // iOS Safari滚动优化
                enhancePreviewScrolling();
            } catch (error) {
                console.error('预览更新错误:', error);
                // IE浏览器备用方案
                try {
                    previewFrame.src = 'data:text/html;charset=utf-8,' + encodeURIComponent(content);
                } catch (ieError) {
                    console.error('IE预览备用方案错误:', ieError);
                    showToast('预览显示失败', 'error');
                }
            }
        }

        // 增强预览窗口的滚动体验
        function enhancePreviewScrolling() {
            try {
                const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                
                if (!previewDoc || !previewDoc.body) {
                    return;
                }

                // 为预览文档添加iOS Safari滚动优化样式
                const style = previewDoc.createElement('style');
                style.textContent = `
                    /* iOS Safari滚动优化 */
                    html, body {
                        -webkit-overflow-scrolling: touch !important;
                        overscroll-behavior: contain !important;
                        touch-action: pan-x pan-y !important;
                        /* 确保内容可以滚动 */
                        overflow: auto !important;
                        /* 防止iOS Safari的橡皮筋效果影响滚动 */
                        position: relative !important;
                    }
                    
                    /* 针对A4版面内容的滚动优化 */
                    body {
                        min-height: 100vh !important;
                        /* 允许内容超出视口 */
                        overflow-x: auto !important;
                        overflow-y: auto !important;
                    }
                    
                    /* 确保所有容器都支持滚动 */
                    * {
                        -webkit-overflow-scrolling: touch !important;
                    }
                `;
                
                // 将样式添加到预览文档的头部
                if (previewDoc.head) {
                    previewDoc.head.appendChild(style);
                } else {
                    // 如果没有head标签，创建一个
                    const head = previewDoc.createElement('head');
                    head.appendChild(style);
                    previewDoc.documentElement.insertBefore(head, previewDoc.body);
                }
                
                // iOS Safari特殊处理：确保iframe内容可以滚动
                if (isIOS()) {
                    // 延迟执行以确保内容完全加载
                    setTimeout(() => {
                        try {
                            const previewBody = previewDoc.body;
                            if (previewBody) {
                                // 添加触摸事件监听器
                                previewBody.addEventListener('touchstart', function(e) {
                                    // 允许触摸滚动
                                    e.stopPropagation();
                                }, { passive: true });
                                
                                previewBody.addEventListener('touchmove', function(e) {
                                    // 允许触摸滚动
                                    e.stopPropagation();
                                }, { passive: true });
                                
                                // 确保内容可以滚动
                                previewBody.style.overflow = 'auto';
                                previewBody.style.webkitOverflowScrolling = 'touch';
                            }
                        } catch (error) {
                            console.log('iOS滚动优化错误:', error);
                        }
                    }, 100);
                }
                
                // Android 设备：单指拖动滚动回退方案（适配固定版面/A4内容）
                try {
                    const isAndroid = /Android/i.test(navigator.userAgent);
                    if (isAndroid) {
                        const scrollEl = previewDoc.scrollingElement || previewDoc.documentElement || previewDoc.body;
                        if (!scrollEl) return;

                        // 确保滚动开启，并减少浏览器手势干扰
                        const targets = [previewDoc.documentElement, previewDoc.body];
                        targets.forEach(el => {
                            if (!el) return;
                            el.style.overflowX = 'auto';
                            el.style.overflowY = 'auto';
                            el.style.overscrollBehavior = 'contain';
                            // 为确保手势由我们接管，禁用浏览器默认手势解析
                            el.style.touchAction = 'none';
                        });

                        let isTouching = false;
                        let startX = 0;
                        let startY = 0;
                        let startScrollLeft = 0;
                        let startScrollTop = 0;

                        previewDoc.addEventListener('touchstart', function(e) {
                            if (e.touches.length !== 1) return;
                            isTouching = true;
                            const t = e.touches[0];
                            startX = t.clientX;
                            startY = t.clientY;
                            startScrollLeft = scrollEl.scrollLeft;
                            startScrollTop = scrollEl.scrollTop;
                        }, { passive: true });

                        previewDoc.addEventListener('touchmove', function(e) {
                            if (!isTouching || e.touches.length !== 1) return;
                            const t = e.touches[0];
                            const dx = t.clientX - startX;
                            const dy = t.clientY - startY;
                            // 反向设置以符合拖动直觉
                            scrollEl.scrollLeft = startScrollLeft - dx;
                            scrollEl.scrollTop = startScrollTop - dy;
                            // 阻止浏览器默认行为，避免页面层面的手势拦截
                            e.preventDefault();
                        }, { passive: false });

                        previewDoc.addEventListener('touchend', function() {
                            isTouching = false;
                        }, { passive: true });
                    }
                } catch (androidEnhanceError) {
                    console.log('Android滚动增强错误:', androidEnhanceError);
                }
                
            } catch (error) {
                console.log('预览滚动优化错误:', error);
            }
        }

        function clearEditor() {
            if (confirm('确定要清空编辑器吗？')) {
                // iOS Safari/Edge浏览器兼容性处理
                // 初始化编辑器 - 修改为清空状态
                htmlEditor.value = '';
                updateCharCount();
                
                // 确保预览区域也是空的
                updatePreview();
                
                // 延迟再次清空确保完全初始化
                setTimeout(function() {
                    updatePreview();
                    updateCharCount();
                }, 100);
                
                setTimeout(function() {
                    updatePreview();
                    updateCharCount();
                }, 200);
                
                // 清除本地存储
                localStorage.removeItem('htmlEditorContent');
                
                showToast('编辑器已清空', 'success');
            }
        }

        function updateCharCount() {
            charCount.textContent = htmlEditor.value.length;
        }

        // 弹出式窗口控制函数
        function showModal(title, content) {
            const modalOverlay = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.textContent = title;
            modalContent.innerHTML = content;
            modalOverlay.classList.add('show');
            
            // 添加ESC键关闭功能
            document.addEventListener('keydown', handleModalEscape);
            
            // 添加点击遮罩层关闭功能
            modalOverlay.addEventListener('click', handleModalOverlayClick);
        }
        
        function closeModal() {
            const modalOverlay = document.getElementById('modalOverlay');
            modalOverlay.classList.remove('show');
            
            // 移除事件监听器
            document.removeEventListener('keydown', handleModalEscape);
            modalOverlay.removeEventListener('click', handleModalOverlayClick);
            
            // 关闭下拉菜单
            closePreviewDropdown();
        }
        
        function handleModalEscape(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        }
        
        function handleModalOverlayClick(event) {
            if (event.target === event.currentTarget) {
                closeModal();
            }
        }
        
        // 预览下拉菜单功能
        function togglePreviewDropdown() {
            const dropdownMenu = document.getElementById('previewDropdownMenu');
            const dropdownBtn = document.getElementById('previewDropdownBtn');
            
            dropdownMenu.classList.toggle('show');
            
            // 更新下拉箭头方向
            const arrowSpan = dropdownBtn.querySelector('span:last-child');
            if (dropdownMenu.classList.contains('show')) {
                arrowSpan.textContent = '▲';
                // 点击外部关闭下拉菜单
                document.addEventListener('click', closePreviewDropdownOnClickOutside);
            } else {
                arrowSpan.textContent = '▼';
                document.removeEventListener('click', closePreviewDropdownOnClickOutside);
            }
        }
        
        // 点击外部关闭下拉菜单
        function closePreviewDropdownOnClickOutside(event) {
            const dropdownMenu = document.getElementById('previewDropdownMenu');
            const dropdownBtn = document.getElementById('previewDropdownBtn');
            
            if (!dropdownBtn.contains(event.target) && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.remove('show');
                dropdownBtn.querySelector('span:last-child').textContent = '▼';
                document.removeEventListener('click', closePreviewDropdownOnClickOutside);
            }
        }
        
        // 面板切换函数 - 改为弹窗显示
        function toggleHistoryPanel() {
            const historyContent = `
                <div style="max-height: 60vh; overflow-y: auto;">
                    <div style="margin-bottom: 16px; display: flex; gap: 8px; justify-content: space-between; align-items: center;">
                        <div>
                            <button class="btn btn-sm btn-danger" onclick="clearHistory()">清空历史</button>
                        </div>
                    </div>
                    <div id="modalHistoryList"></div>
                </div>
            `;
            showModal('📋 历史记录', historyContent);
            renderModalHistory();
            closePreviewDropdown();
        }
        
        function toggleSharePanel() {
            const shareContent = `
                <div>
                    <p style="color: #e6e6e6; margin-bottom: 16px; font-size: 14px; line-height: 1.6;">生成一个可分享的链接，其他人可以通过该链接查看和编辑当前内容：</p>
                    <div style="display: flex; margin-bottom: 20px; gap: 8px; align-items: center;">
                        <input type="text" id="modalShareLink" class="share-link-input" readonly style="flex: 1;">
                        <button class="btn btn-sm btn-primary" onclick="copyModalShareLink()">复制链接</button>
                    </div>
                    <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="generateShareLink()">重新生成</button>
                        <button class="btn btn-success" onclick="openModalShareLink()">在新窗口打开</button>
                        <button class="btn btn-primary" onclick="generateOnlineLink()">自动生成在线链接</button>
                    </div>
                    
                    <!-- 分享历史管理 -->
                    <div class="share-history-section" style="margin-bottom: 20px; padding: 16px; background: #2a2a2a; border-radius: 8px; border: 1px solid #3a3a3a;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4>📚 分享历史</h4>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-secondary" onclick="refreshModalShareHistory()">刷新</button>
                                <button class="btn btn-sm btn-danger" onclick="clearModalShareHistory()">清空历史</button>
                            </div>
                        </div>
                        <div id="modalShareHistoryList" style="max-height: 200px; overflow-y: auto;">
                            <p style="color: #888888; font-size: 13px; text-align: center; padding: 20px; font-style: italic;">暂无分享历史</p>
                        </div>
                    </div>
                    
                    <div class="share-tips" style="background: #2a2a2a; padding: 16px; border-radius: 8px; border-left: 4px solid #0066ff;">
                        <h4 style="color: #e6e6e6; margin-bottom: 12px; font-size: 14px; font-weight: 500;">💡 分享提示：</h4>
                        <ul style="list-style-type: disc; list-style-position: inside; color: #888888; font-size: 13px;">
                            <li style="margin-bottom: 8px; line-height: 1.5;">链接包含了当前编辑器的所有内容</li>
                            <li style="margin-bottom: 8px; line-height: 1.5;">链接可以被任何人访问和修改</li>
                            <li style="margin-bottom: 8px; line-height: 1.5;">新压缩算法可显著减少链接长度</li>
                            <li style="margin-bottom: 8px; line-height: 1.5;">刷新页面后链接仍然有效</li>
                            <li style="margin-bottom: 8px; line-height: 1.5;">可在设置中自定义分享链接的基础URL</li>
                            <li style="margin-bottom: 8px; line-height: 1.5;">分享历史会自动保存，方便管理之前的分享</li>
                        </ul>
                    </div>
                </div>
            `;
            showModal('🔗 分享链接', shareContent);
            generateModalShareLink();
            refreshModalShareHistory();
            closePreviewDropdown();
        }
        
        function toggleSettingsPanel() {
            const settingsContent = `
                <div style="max-height: 60vh; overflow-y: auto;">
                    <div style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #2a2a2a;">
                        <h4 style="color: #e6e6e6; margin-bottom: 16px; font-size: 14px; font-weight: 500;">🔗 分享设置</h4>
                        <div style="margin-bottom: 16px;">
                            <label for="modalShareBaseUrl" class="setting-label" style="display: block; color: #e6e6e6; margin-bottom: 8px; font-size: 13px; font-weight: 500;">分享链接基础URL：</label>
                            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap;">
                                <input type="text" id="modalShareBaseUrl" class="setting-input" placeholder="例如：https://example.com/editor.html" style="padding: 8px 12px; background: #0d0d0d; border: 1px solid #2a2a2a; color: #e6e6e6; font-size: 13px; border-radius: 4px; outline: none; min-width: 200px;">
                                <button class="btn btn-sm btn-primary" onclick="saveModalShareBaseUrl()">保存</button>
                                <button class="btn btn-sm btn-secondary" onclick="resetModalShareBaseUrl()">重置</button>
                            </div>
                            <p style="color: #888888; font-size: 11px; line-height: 1.5; margin: 0;">设置用于生成分享链接的基础URL，默认使用当前页面URL。</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #2a2a2a;">
                        <h4 style="color: #e6e6e6; margin-bottom: 16px; font-size: 14px; font-weight: 500;">💾 自动保存</h4>
                        <div style="margin-bottom: 16px;">
                            <label for="modalAutoSaveInterval" class="setting-label" style="display: block; color: #e6e6e6; margin-bottom: 8px; font-size: 13px; font-weight: 500;">自动保存间隔（秒）：</label>
                            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap;">
                                <input type="number" id="modalAutoSaveInterval" class="setting-input" min="1" max="600" value="10" style="padding: 8px 12px; background: #0d0d0d; border: 1px solid #2a2a2a; color: #e6e6e6; font-size: 13px; border-radius: 4px; outline: none; min-width: 80px; width: 80px;">
                                <button class="btn btn-sm btn-primary" onclick="saveModalAutoSaveInterval()">保存</button>
                            </div>
                            <p style="color: #888888; font-size: 11px; line-height: 1.5; margin: 0;">设置编辑器自动保存内容的时间间隔。</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #2a2a2a;">
                        <h4 style="color: #e6e6e6; margin-bottom: 16px; font-size: 14px; font-weight: 500;">📝 历史记录</h4>
                        <div style="margin-bottom: 16px;">
                            <label for="modalMaxHistoryRecords" class="setting-label" style="display: block; color: #e6e6e6; margin-bottom: 8px; font-size: 13px; font-weight: 500;">最大历史记录数：</label>
                            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap;">
                                <input type="number" id="modalMaxHistoryRecords" class="setting-input" min="1" max="50" value="10" style="padding: 8px 12px; background: #0d0d0d; border: 1px solid #2a2a2a; color: #e6e6e6; font-size: 13px; border-radius: 4px; outline: none; min-width: 80px; width: 80px;">
                                <button class="btn btn-sm btn-primary" onclick="saveModalMaxHistoryRecords()">保存</button>
                            </div>
                            <p style="color: #888888; font-size: 11px; line-height: 1.5; margin: 0;">设置编辑器保存的最大历史记录数量。</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-top: 20px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="applyModalAllSettings()">应用所有设置</button>
                        <button class="btn btn-secondary" onclick="loadModalSettings()">重新加载设置</button>
                    </div>
                </div>
            `;
            showModal('⚙️ 编辑器设置', settingsContent);
            loadModalSettings();
         }
         
         // 弹窗历史记录渲染函数
         function renderModalHistory() {
             const modalHistoryList = document.getElementById('modalHistoryList');
             if (!modalHistoryList) return;
             
             const history = JSON.parse(localStorage.getItem('editorHistory') || '[]');
             
             if (history.length === 0) {
                 modalHistoryList.innerHTML = '<p style="color: #888888; font-size: 13px; text-align: center; padding: 20px; font-style: italic;">暂无历史记录</p>';
                 return;
             }
             
             modalHistoryList.innerHTML = history.map((item, index) => `
                 <div style="padding: 12px; margin-bottom: 8px; background: #1a1a1a; border-radius: 6px; border: 1px solid #2a2a2a; cursor: pointer; transition: all 0.2s;" 
                      onmouseover="this.style.background='#252525'; this.style.borderColor='#3a3a3a';" 
                      onmouseout="this.style.background='#1a1a1a'; this.style.borderColor='#2a2a2a';"
                      onclick="loadModalHistoryItem(${index})">
                     <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                         <div style="flex: 1; margin-right: 12px;">
                             <div style="color: #e6e6e6; font-weight: 500; margin-bottom: 4px; font-size: 14px;">${item.title || '无标题'}</div>
                             <div style="color: #888888; font-size: 12px; line-height: 1.4;">${item.content ? item.content.substring(0, 100) + (item.content.length > 100 ? '...' : '') : '无内容'}</div>
                         </div>
                         <div style="display: flex; gap: 6px; flex-shrink: 0;">
                             <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); loadModalHistoryItem(${index})" title="加载">加载</button>
                             <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteModalHistoryItem(${index})" title="删除">删除</button>
                         </div>
                     </div>
                     <div style="color: #888888; font-size: 11px;">
                         ${new Date(item.timestamp).toLocaleString('zh-CN')}
                     </div>
                 </div>
             `).join('');
         }
         
         // 弹窗历史记录操作函数
         function loadModalHistoryItem(index) {
             const history = JSON.parse(localStorage.getItem('editorHistory') || '[]');
             if (history[index]) {
                 editor.value = history[index].content || '';
                 document.title = history[index].title || 'Markdown 编辑器';
                 updateCharCount();
                 renderPreview();
                 closeModal();
             }
         }
         
         function deleteModalHistoryItem(index) {
             if (confirm('确定要删除这条历史记录吗？')) {
                 const history = JSON.parse(localStorage.getItem('editorHistory') || '[]');
                 history.splice(index, 1);
                 localStorage.setItem('editorHistory', JSON.stringify(history));
                 renderModalHistory();
                 renderHistory(); // 同时更新面板中的历史记录
             }
         }
         
         // 弹窗分享功能函数
         function generateModalShareLink() {
             generateShareLink();
             const shareLink = document.getElementById('shareLink')?.value;
             if (shareLink) {
                 document.getElementById('modalShareLink').value = shareLink;
             }
         }
         
         function copyModalShareLink() {
             const modalShareLink = document.getElementById('modalShareLink');
             if (modalShareLink && modalShareLink.value) {
                 modalShareLink.select();
                 document.execCommand('copy');
                 alert('分享链接已复制到剪贴板！');
             } else {
                 alert('请先生成分享链接！');
             }
         }
         
         function openModalShareLink() {
             const modalShareLink = document.getElementById('modalShareLink');
             if (modalShareLink && modalShareLink.value) {
                 window.open(modalShareLink.value, '_blank');
             } else {
                 alert('请先生成分享链接！');
             }
         }
         
         function refreshModalShareHistory() {
             refreshShareHistory();
             const shareHistoryList = document.getElementById('shareHistoryList');
             const modalShareHistoryList = document.getElementById('modalShareHistoryList');
             if (shareHistoryList && modalShareHistoryList) {
                 modalShareHistoryList.innerHTML = shareHistoryList.innerHTML;
             }
         }
         
         function clearModalShareHistory() {
             if (confirm('确定要清空所有分享历史吗？')) {
                 localStorage.removeItem('shareHistory');
                 refreshModalShareHistory();
             }
         }
         
         // 弹窗设置功能函数
         function saveModalShareBaseUrl() {
             const modalShareBaseUrl = document.getElementById('modalShareBaseUrl');
             if (modalShareBaseUrl) {
                 localStorage.setItem('shareBaseUrl', modalShareBaseUrl.value);
                 alert('分享链接基础URL已保存！');
             }
         }
         
         function resetModalShareBaseUrl() {
             const modalShareBaseUrl = document.getElementById('modalShareBaseUrl');
             if (modalShareBaseUrl) {
                 modalShareBaseUrl.value = window.location.href.split('?')[0];
                 localStorage.setItem('shareBaseUrl', modalShareBaseUrl.value);
                 alert('分享链接基础URL已重置为当前页面URL！');
             }
         }
         
         function saveModalAutoSaveInterval() {
             const modalAutoSaveInterval = document.getElementById('modalAutoSaveInterval');
             if (modalAutoSaveInterval) {
                 const interval = parseInt(modalAutoSaveInterval.value);
                 if (interval > 0 && interval <= 600) {
                     localStorage.setItem('autoSaveInterval', interval);
                     restartAutoSave();
                     alert('自动保存间隔已保存！');
                 } else {
                     alert('自动保存间隔必须在1-600秒之间！');
                 }
             }
         }
         
         function saveModalMaxHistoryRecords() {
             const modalMaxHistoryRecords = document.getElementById('modalMaxHistoryRecords');
             if (modalMaxHistoryRecords) {
                 const maxRecords = parseInt(modalMaxHistoryRecords.value);
                 if (maxRecords > 0 && maxRecords <= 50) {
                     localStorage.setItem('maxHistoryRecords', maxRecords);
                     alert('最大历史记录数已保存！');
                 } else {
                     alert('最大历史记录数必须在1-50之间！');
                 }
             }
         }
         
         function applyModalAllSettings() {
             saveModalShareBaseUrl();
             saveModalAutoSaveInterval();
             saveModalMaxHistoryRecords();
             alert('所有设置已应用！');
         }
         
         function loadModalSettings() {
             loadSettings();
             // 同步面板中的设置值到弹窗
             const shareBaseUrl = document.getElementById('shareBaseUrl');
             const modalShareBaseUrl = document.getElementById('modalShareBaseUrl');
             if (shareBaseUrl && modalShareBaseUrl) {
                 modalShareBaseUrl.value = shareBaseUrl.value;
             }
             
             const autoSaveInterval = document.getElementById('autoSaveInterval');
             const modalAutoSaveInterval = document.getElementById('modalAutoSaveInterval');
             if (autoSaveInterval && modalAutoSaveInterval) {
                 modalAutoSaveInterval.value = autoSaveInterval.value;
             }
             
             const maxHistoryRecords = document.getElementById('maxHistoryRecords');
             const modalMaxHistoryRecords = document.getElementById('modalMaxHistoryRecords');
             if (maxHistoryRecords && modalMaxHistoryRecords) {
                 modalMaxHistoryRecords.value = maxHistoryRecords.value;
             }
         }
        
        // 关闭下拉菜单
        function closePreviewDropdown() {
            const dropdownMenu = document.getElementById('previewDropdownMenu');
            const dropdownBtn = document.getElementById('previewDropdownBtn');
            
            dropdownMenu.classList.remove('show');
            dropdownBtn.querySelector('span:last-child').textContent = '▼';
            document.removeEventListener('click', closePreviewDropdownOnClickOutside);
        }

        // 从剪贴板粘贴
        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                htmlEditor.value = text;
                htmlEditor.focus();
                updatePreview();
                showToast('已从剪贴板粘贴', 'success');
                
                // 添加按钮动画效果
                pasteBtn.classList.add('pasting');
                setTimeout(() => pasteBtn.classList.remove('pasting'), 600);
            } catch (err) {
                showToast('无法访问剪贴板，请手动粘贴', 'error');
            }
        }

        // Toast 消息提示
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            const editorPanel = document.querySelector('.editor-panel');
            (editorPanel || document.body).appendChild(toast);
            
            // iPad设备调整通知位置（针对代码面板内的toast）
            adjustToastPositionForiPad();
            
            // 触发显示动画
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // 1秒后移除（原为3秒）
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 1000);
        }

        function downloadHTML() {
            const code = htmlEditor.value;
            if (!code.trim()) {
                showToast('请先输入HTML代码', 'error');
                return;
            }

            const blob = new Blob([code], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('HTML文件下载成功', 'success');
        }

        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // 快捷键支持
        htmlEditor.addEventListener('keydown', function(e) {
            // Ctrl+S 保存
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                downloadHTML();
            }
            // Ctrl+R 刷新预览
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshPreview();
            }
            // Ctrl+V 粘贴（增强功能） - 兼容各种设备
            if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                // 让浏览器默认粘贴行为发生，然后更新预览
                setTimeout(() => {
                    updatePreview();
                    updateCharCount();
                }, 100);
            }
        });

        // 自动保存功能 - 优化移动设备体验
        let autoSaveTimeout;
        htmlEditor.addEventListener('input', function() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(function() {
                localStorage.setItem('htmlEditorContent', htmlEditor.value);
                // 每10秒自动添加到历史记录
                if (Date.now() - lastHistoryAddTime > 10000) {
                    addToHistory();
                    lastHistoryAddTime = Date.now();
                }
            }, 1000);
        });
        
        // iOS Edge浏览器：监听change事件用于自动保存
        htmlEditor.addEventListener('change', function() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(function() {
                localStorage.setItem('htmlEditorContent', htmlEditor.value);
                addToHistory();
            }, 1000);
        });
        
        // 历史记录添加时间戳
        let lastHistoryAddTime = Date.now();
        
        // 页面卸载时添加到历史记录
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('htmlEditorContent', htmlEditor.value);
            addToHistory();
        });
        
        // 切换历史记录面板显示/隐藏
        function toggleHistoryPanel() {
            historyPanel.classList.toggle('show');
            if (historyPanel.classList.contains('show')) {
                displayHistory();
            }
        }
        
        // 关闭所有面板
        function closeAllPanels() {
            historyPanel.classList.remove('show');
            sharePanel.classList.remove('show');
            settingsPanel.classList.remove('show');
        }
        
        // 关闭所有面板
        function closeAllPanels() {
            historyPanel.classList.remove('show');
            sharePanel.classList.remove('show');
            settingsPanel.classList.remove('show');
        }
        
        // 显示历史记录列表
        function displayHistory() {
            if (historyRecords.length === 0) {
                historyList.innerHTML = '<div class="history-empty">暂无历史记录</div>';
                return;
            }
            
            historyList.innerHTML = historyRecords.map(record => {
                const date = new Date(record.timestamp).toLocaleString('zh-CN');
                return `
                    <div class="history-item" onclick="restoreFromHistory(${record.id})">
                        <div class="history-item-content">${escapeHtml(record.preview)}</div>
                        <div class="history-item-info">
                            <span>${date}</span>
                            <button class="history-item-delete" onclick="event.stopPropagation(); deleteHistoryItem(${record.id})">×</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 从历史记录恢复代码
        function restoreFromHistory(id) {
            const record = historyRecords.find(r => r.id === id);
            if (record) {
                htmlEditor.value = record.content;
                updatePreview();
                updateCharCount();
                closeAllPanels();
                showToast('已从历史记录恢复', 'success');
            }
        }
        
        // 删除单条历史记录
        function deleteHistoryItem(id) {
            historyRecords = historyRecords.filter(r => r.id !== id);
            saveHistory();
            displayHistory();
            showToast('历史记录已删除', 'success');
        }
        
        // 清空所有历史记录
        function clearHistory() {
            if (confirm('确定要清空所有历史记录吗？')) {
                historyRecords = [];
                localStorage.removeItem(HISTORY_STORAGE_KEY);
                displayHistory();
                showToast('历史记录已清空', 'success');
            }
        }
        
        // HTML转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 页面可见性变化时保存 - 移动设备优化
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                localStorage.setItem('htmlEditorContent', htmlEditor.value);
            }
        });
        
        // 页面卸载前保存
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('htmlEditorContent', htmlEditor.value);
        });
        
        // 移动设备优化：处理页面切换和后台运行
        window.addEventListener('blur', function() {
            localStorage.setItem('htmlEditorContent', htmlEditor.value);
        });
        
        // 处理设备旋转
        // 处理视口高度变化和设备方向变化
        function updateViewportHeight() {
            // 获取真实的视口高度
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            
            // 更新编辑器高度
            htmlEditor.style.height = 'auto';
            htmlEditor.style.height = htmlEditor.scrollHeight + 'px';
            
            // 处理通知位置
            const toast = document.querySelector('.editor-panel .toast');
            if (toast) {
                const isLandscape = window.innerWidth > window.innerHeight;
                toast.style.top = isLandscape ? '85px' : '80px';
            }
        }

        // 监听方向变化
        window.addEventListener('orientationchange', function() {
            // 等待方向变化完成
            setTimeout(updateViewportHeight, 300);
        });

        // 监听视口大小变化（包括地址栏收起/展开）
        window.addEventListener('resize', function() {
            updateViewportHeight();
        });

        // 初始化视口高度
        updateViewportHeight();
        
        // iPad检测函数
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }
        
        // 动态调整iPad通知位置
        function adjustToastPositionForiPad() {
            if (isIOS()) {
                const toast = document.querySelector('.editor-panel .toast');
                if (toast) {
                    // 检测是否为横屏
                    const isLandscape = window.innerWidth > window.innerHeight;
                    if (isLandscape) {
                        // 横屏模式增加顶部距离
                        const screenWidth = window.innerWidth;
                        if (screenWidth >= 1366) {
                            // iPad Pro
                            toast.style.top = '90px';
                        } else if (screenWidth >= 1024) {
                            // 标准iPad
                            toast.style.top = '80px';
                        } else {
                            // 较小iPad
                            toast.style.top = '75px';
                        }
                    } else {
                        // 竖屏模式使用CSS中定义的位置
                        toast.style.top = '';
                    }
                }
            }
        }
        
        // 监听窗口大小变化
        window.addEventListener('resize', adjustToastPositionForiPad);

        function loadFromLocalStorage() {
            // 修改为不自动加载之前的内容，保持清空状态
            // 可以在这里添加欢迎信息或其他初始化逻辑
            showToast('HTML编辑器已准备就绪', 'success');
        }
        
        // 功能简介显示函数
        function showHelp() {
            // 创建模态框
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 16px;
                max-width: 500px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 2px 12px rgba(0,0,0,0.08);
                margin: 20px;
            `;
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: #1d1d1f; margin: 0 0 10px 0; font-size: 24px; font-weight: 600;">🎉 欢迎使用HTML5编辑器</h2>
                    <p style="color: #86868b; margin: 0; font-size: 16px;">这是一个响应式的HTML5页面模板，完美适配iOS、Android、macOS和Windows设备。</p>
                </div>
                
                <div style="background: #f5f5f7; padding: 15px; border-radius: 12px; margin: 15px 0;">
                    <h3 style="color: #1d1d1f; margin: 0 0 8px 0; font-size: 18px;">📱 移动优先</h3>
                    <p style="color: #86868b; margin: 0; font-size: 14px;">在各种移动设备上都有出色的显示效果</p>
                </div>
                
                <div style="background: #f5f5f7; padding: 15px; border-radius: 12px; margin: 15px 0;">
                    <h3 style="color: #1d1d1f; margin: 0 0 8px 0; font-size: 18px;">💻 跨平台兼容</h3>
                    <p style="color: #86868b; margin: 0; font-size: 14px;">支持iOS、Android、macOS、Windows等主流平台</p>
                </div>
                
                <div style="background: #f5f5f7; padding: 15px; border-radius: 12px; margin: 15px 0;">
                    <h3 style="color: #1d1d1f; margin: 0 0 8px 0; font-size: 18px;">🚀 性能优化</h3>
                    <p style="color: #86868b; margin: 0; font-size: 14px;">快速加载，流畅的用户体验</p>
                </div>
                
                <div style="background: #f5f5f7; padding: 15px; border-radius: 12px; margin: 15px 0;">
                    <h3 style="color: #1d1d1f; margin: 0 0 8px 0; font-size: 18px;">📝 实时编辑</h3>
                    <p style="color: #86868b; margin: 0; font-size: 14px;">所见即所得的HTML编辑体验</p>
                </div>
                
                <div style="background: #f5f5f7; padding: 15px; border-radius: 12px; margin: 15px 0;">
                    <h3 style="color: #1d1d1f; margin: 0 0 8px 0; font-size: 18px;">💾 智能保存</h3>
                    <p style="color: #86868b; margin: 0; font-size: 14px;">自动保存功能，防止内容丢失</p>
                </div>
                
                <div style="background: #f5f5f7; padding: 15px; border-radius: 12px; margin: 15px 0; text-align: center;">
                    <h3 style="color: #1d1d1f; margin: 0 0 8px 0; font-size: 16px;">👨‍💻 作者信息</h3>
                    <p style="color: #86868b; margin: 0; font-size: 14px;">pHotter Song</p>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="document.querySelector('.modal').remove()" style="
                        background: #007aff;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        font-weight: 500;
                    ">关闭</button>
                </div>
            `;
            
            modal.appendChild(content);
            modal.className = 'modal';
            
            // 点击背景关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // 打印预览函数 - 优化iOS Safari兼容性
        function printPreview() {
            try {
                const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                
                // 检查预览内容是否为空
                if (!previewDoc.body || !previewDoc.body.innerHTML.trim()) {
                    showToast('预览内容为空，请先输入一些内容', 'error');
                    return;
                }

                // iOS Safari特殊处理
                if (isIOS()) {
                    // 在iOS Safari中，直接在当前窗口打印预览内容
                    printCurrentPreview();
                    return;
                }

                // 创建打印样式
                const style = document.createElement('style');
                style.textContent = `
                    @media print {
                        @page { margin: 1cm; }
                        body { 
                            margin: 0;
                            padding: 0;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                        }
                        * { 
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                    }
                `;

                // 创建一个新的打印窗口
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    showToast('无法打开打印窗口，请检查是否被浏览器阻止', 'error');
                    return;
                }

                // 复制所有原始样式表
                const styleSheets = Array.from(previewDoc.styleSheets);
                const styleLinks = styleSheets.map(sheet => {
                    if (sheet.href) {
                        return `<link rel="stylesheet" href="${sheet.href}">`;
                    } else if (sheet.ownerNode && sheet.ownerNode.textContent) {
                        return `<style>${sheet.ownerNode.textContent}</style>`;
                    }
                    return '';
                }).join('');

                // 构建打印页面
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>打印预览</title>
                        ${styleLinks}
                        ${style.outerHTML}
                    </head>
                    <body>
                        ${previewDoc.body.innerHTML}
                    </body>
                    </html>
                `);
                printWindow.document.close();

                // 等待资源加载完成后打印
                if (printWindow.document.readyState === 'complete') {
                    printWindow.print();
                } else {
                    printWindow.addEventListener('load', function() {
                        printWindow.print();
                    });
                }

                // 打印完成后关闭窗口
                const checkPrintCompletion = setInterval(() => {
                    if (!printWindow || printWindow.closed) {
                        clearInterval(checkPrintCompletion);
                    }
                }, 1000);

                showToast('正在打开打印预览...', 'success');
            } catch (error) {
                console.error('打印出错:', error);
                showToast('打印功能出错，请重试', 'error');
            }
        }

        // iOS Safari专用打印函数
        function printCurrentPreview() {
            try {
                const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                
                // 创建临时打印样式
                const printStyle = document.createElement('style');
                printStyle.textContent = `
                    @media print {
                        @page { margin: 1cm; }
                        body { 
                            margin: 0;
                            padding: 0;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
                        }
                        * { 
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                    }
                `;
                
                // 将打印样式添加到预览文档
                previewDoc.head.appendChild(printStyle);
                
                // 直接打印预览框架
                previewFrame.contentWindow.print();
                
                // 延迟移除打印样式
                setTimeout(() => {
                    if (printStyle.parentNode) {
                        printStyle.parentNode.removeChild(printStyle);
                    }
                }, 1000);
                
                showToast('正在打印预览内容...', 'success');
            } catch (error) {
                console.error('iOS打印出错:', error);
                showToast('iOS打印功能出错，请重试', 'error');
            }
        }

        // 全屏预览切换函数
        function toggleFullscreenPreview() {
            const previewPanel = document.querySelector('.preview-panel');
            
            if (previewPanel.classList.contains('fullscreen-preview')) {
                // 退出全屏
                previewPanel.classList.remove('fullscreen-preview');
                // 移除关闭按钮
                const closeBtn = document.querySelector('.fullscreen-close');
                if (closeBtn) {
                    closeBtn.addEventListener('transitionend', function() {
                        document.body.removeChild(closeBtn);
                    });
                    closeBtn.style.opacity = '0';
                }
            } else {
                // 进入全屏
                previewPanel.classList.add('fullscreen-preview');
                // 添加关闭按钮
                const closeBtn = document.createElement('button');
                closeBtn.className = 'fullscreen-close';
                closeBtn.onclick = toggleFullscreenPreview;
                closeBtn.title = '退出全屏';
                document.body.appendChild(closeBtn);
                // 延迟显示关闭按钮以实现淡入效果
                requestAnimationFrame(() => closeBtn.style.opacity = '0.3');
            }
            
            // 延迟刷新预览以确保正确渲染
            setTimeout(() => {
                refreshPreview();
            }, 100);
        }

        // iOS兼容性检测和错误处理
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }
        
        function isIOSSafari() {
            return isIOS() && /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent) && !/CriOS/.test(navigator.userAgent);
        }
        
        function isIOSEdge() {
            return isIOS() && /EdgiOS|Edge/.test(navigator.userAgent);
        }
        
        // 增强的iOS错误处理
        function handleIOSError(operation, error) {
            console.warn(`iOS ${operation} 错误:`, error);
            
            if (isIOSSafari()) {
                showToast('iOS Safari兼容性提示：如遇到问题，请尝试双击输入区域', 'warning');
            } else if (isIOSEdge()) {
                showToast('iOS Edge兼容性提示：功能可能受限，建议使用Safari', 'warning');
            }
        }
        
        // 加载历史记录
        function loadHistory() {
            try {
                const stored = localStorage.getItem(HISTORY_STORAGE_KEY);
                if (stored) {
                    historyRecords = JSON.parse(stored);
                }
            } catch (error) {
                console.error('加载历史记录失败:', error);
                historyRecords = [];
            }
        }
        
        // 保存历史记录到localStorage
        function saveHistory() {
            try {
                localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(historyRecords));
            } catch (error) {
                console.error('保存历史记录失败:', error);
            }
        }
        
        // 添加当前代码到历史记录
        function addToHistory() {
            const code = htmlEditor.value.trim();
            if (!code) return;
            
            // 检查是否与最近一条记录相同
            if (historyRecords.length > 0 && historyRecords[0].content === code) {
                return;
            }
            
            // 创建新的历史记录
            const record = {
                id: Date.now(),
                content: code,
                timestamp: new Date().toISOString(),
                preview: code.substring(0, 100) + (code.length > 100 ? '...' : '')
            };
            
            // 添加到历史记录开头
            historyRecords.unshift(record);
            
            // 限制历史记录数量
            if (historyRecords.length > MAX_HISTORY_RECORDS) {
                historyRecords = historyRecords.slice(0, MAX_HISTORY_RECORDS);
            }
            
            // 保存到localStorage
            saveHistory();
            
            // 如果历史面板已打开，更新显示
            if (historyPanel.classList.contains('show')) {
                displayHistory();
            }
        }
        
        // 页面加载时尝试恢复保存的内容
        window.addEventListener('load', function() {
            try {
                // 加载设置
                loadSettings();
                
                // 首先检查是否有分享链接参数
                loadFromShareUrl();
                
                // 如果没有分享内容，再从localStorage加载
                if (!htmlEditor.value.trim()) {
                    loadFromLocalStorage();
                }
                
                loadHistory();
                
                // iOS设备特殊处理
                if (isIOS()) {
                    // 延迟初始化确保iOS完全加载
                    setTimeout(function() {
                        htmlEditor.focus();
                        htmlEditor.blur();
                    }, 500);
                    
                    console.log('检测到iOS设备，已应用兼容性优化');
                }
                
                console.log('HTML编辑器已加载，历史记录功能已初始化');
                console.log('当前历史记录数量:', historyRecords.length);
                console.log('分享基础URL:', shareBaseUrl || '使用当前页面URL');
            } catch (error) {
                handleIOSError('页面加载', error);
            }
        });
        
        // 测试历史记录功能（可选）
        function testHistory() {
            console.log('=== 测试历史记录功能 ===');
            
            // 测试添加到历史记录
            htmlEditor.value = '<h1>测试历史记录 1</h1>';
            addToHistory();
            console.log('添加第一条历史记录后数量:', historyRecords.length);
            
            htmlEditor.value = '<h1>测试历史记录 2</h1>';
            addToHistory();
            console.log('添加第二条历史记录后数量:', historyRecords.length);
            
            // 测试显示历史记录
            displayHistory();
            
            console.log('=== 历史记录测试完成 ===');
        }
        
        // 测试分享功能（可选）
        function testShare() {
            console.log('=== 测试分享功能 ===');
            
            // 测试1：生成分享链接
            htmlEditor.value = '<h1>测试分享功能</h1><p>这是一个测试分享的内容</p>';
            generateShareLink();
            console.log('分享链接已生成:', shareLink.value);
            
            // 测试2：验证链接是否包含内容
            const hasContent = shareLink.value.includes(SHARE_PARAM_NAME);
            console.log('分享链接包含内容参数:', hasContent);
            
            // 测试3：模拟从分享链接加载
            const testUrl = new URL(shareLink.value);
            const encodedContent = testUrl.searchParams.get(SHARE_PARAM_NAME);
            const decodedContent = decodeURIComponent(atob(encodedContent));
            console.log('解码后的内容:', decodedContent);
            console.log('解码内容与原内容匹配:', decodedContent === htmlEditor.value);
            
            console.log('=== 分享功能测试完成 ===');
        }
        
        // 快捷键支持：Ctrl+H 打开历史记录
        htmlEditor.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                e.preventDefault();
                toggleHistoryPanel();
            }
            // Ctrl+Shift+S 打开分享面板
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 's') {
                e.preventDefault();
                toggleSharePanel();
            }
        });
        
        // 切换分享面板显示/隐藏
        function toggleSharePanel() {
            sharePanel.classList.toggle('show');
            if (sharePanel.classList.contains('show')) {
                generateShareLink();
            }
        }
        
        // 生成分享链接
        function generateShareLink() {
            const content = htmlEditor.value;
            if (!content.trim()) {
                showToast('请先输入内容再生成分享链接', 'error');
                return;
            }
            
            try {
                // 使用LZString压缩内容（如果可用）或简单的内容压缩
                let compressedContent;
                let compressionMethod = 'base64';
                
                // 首先尝试压缩内容
                const originalLength = content.length;
                
                // 尝试简单的重复模式压缩
                compressedContent = compressContent(content);
                
                // 如果压缩效果不明显，使用Base64编码
                if (compressedContent.length >= originalLength * 0.8) {
                    compressedContent = btoa(encodeURIComponent(content));
                    compressionMethod = 'base64';
                } else {
                    compressionMethod = 'custom';
                }
                
                let url;
                
                // 使用自定义分享基础URL或当前页面URL
                if (shareBaseUrl) {
                    url = new URL(shareBaseUrl);
                } else {
                    url = new URL(window.location.href);
                }
                
                // 移除可能存在的旧内容参数
                url.searchParams.delete(SHARE_PARAM_NAME);
                url.searchParams.delete('method');
                
                // 添加压缩方法和内容参数
                url.searchParams.append('method', compressionMethod);
                url.searchParams.append(SHARE_PARAM_NAME, compressedContent);
                
                // 更新分享链接输入框
                shareLink.value = url.toString();
                
                const savedLength = url.toString().length;
                const savedPercent = Math.round((1 - savedLength / (originalLength + 100)) * 100);
                showToast(`分享链接已生成，压缩率: ${savedPercent}%`, 'success');
                
            } catch (error) {
                console.error('生成分享链接失败:', error);
                showToast('生成分享链接失败，请检查URL格式', 'error');
            }
        }
        
        // 简单的内容压缩函数
        function compressContent(content) {
            // 移除不必要的空白字符
            let compressed = content.replace(/\s+/g, ' ').trim();
            
            // 压缩常见的HTML标签
            const tagReplacements = {
                '<div>': '①',
                '</div>': '②',
                '<p>': '③',
                '</p>': '④',
                '<span>': '⑤',
                '</span>': '⑥',
                '<h1>': '⑦',
                '</h1>': '⑧',
                '<h2>': '⑨',
                '</h2>': '⑩',
                '<br>': '⑪',
                '<br/>': '⑫',
                '&nbsp;': '⑬'
            };
            
            for (const [tag, replacement] of Object.entries(tagReplacements)) {
                compressed = compressed.replace(new RegExp(tag.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), replacement);
            }
            
            // 使用自定义编码
            return btoa(encodeURIComponent(compressed));
        }
        
        // 解压缩内容
        function decompressContent(compressed) {
            let decompressed = decodeURIComponent(atob(compressed));
            
            // 还原HTML标签
            const tagReplacements = {
                '①': '<div>',
                '②': '</div>',
                '③': '<p>',
                '④': '</p>',
                '⑤': '<span>',
                '⑥': '</span>',
                '⑦': '<h1>',
                '⑧': '</h1>',
                '⑨': '<h2>',
                '⑩': '</h2>',
                '⑪': '<br>',
                '⑫': '<br/>',
                '⑬': '&nbsp;'
            };
            
            for (const [replacement, tag] of Object.entries(tagReplacements)) {
                decompressed = decompressed.replace(new RegExp(replacement, 'g'), tag);
            }
            
            return decompressed;
        }
        
        // 复制分享链接到剪贴板
        function copyShareLink() {
            const link = shareLink.value;
            if (!link) {
                showToast('请先生成分享链接', 'error');
                return;
            }
            
            try {
                // 使用Clipboard API复制链接
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(link).then(() => {
                        showToast('链接已复制到剪贴板', 'success');
                    }).catch(() => {
                        fallbackCopyShareLink(link);
                    });
                } else {
                    fallbackCopyShareLink(link);
                }
            } catch (error) {
                console.error('复制链接失败:', error);
                fallbackCopyShareLink(link);
            }
        }
        
        // 复制链接的降级方案
        function fallbackCopyShareLink(link) {
            try {
                // 创建临时textarea元素
                const textArea = document.createElement('textarea');
                textArea.value = link;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                // 执行复制命令
                const success = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (success) {
                    showToast('链接已复制到剪贴板', 'success');
                } else {
                    showToast('复制失败，请手动复制', 'error');
                }
            } catch (error) {
                console.error('降级复制方案失败:', error);
                showToast('复制失败，请手动复制', 'error');
            }
        }
        
        // 在新窗口打开分享链接
        function openShareLink() {
            const link = shareLink.value;
            if (!link) {
                showToast('请先生成分享链接', 'error');
                return;
            }
            
            try {
                window.open(link, '_blank');
                showToast('分享链接已在新窗口打开', 'success');
            } catch (error) {
                console.error('打开分享链接失败:', error);
                showToast('打开分享链接失败，请手动打开', 'error');
            }
        }
        
        // 从URL参数加载分享内容
        function loadFromShareUrl() {
            try {
                const url = new URL(window.location.href);
                const encodedContent = url.searchParams.get(SHARE_PARAM_NAME);
                const compressionMethod = url.searchParams.get('method') || 'base64';
                
                if (encodedContent) {
                    // 根据压缩方法解码内容
                    let content;
                    if (compressionMethod === 'custom') {
                        content = decompressContent(encodedContent);
                    } else {
                        content = decodeURIComponent(atob(encodedContent));
                    }
                    
                    htmlEditor.value = content;
                    updatePreview();
                    updateCharCount();
                    showToast('已加载分享内容', 'success');
                    console.log('从分享链接加载内容成功');
                }
            } catch (error) {
                console.error('从分享链接加载内容失败:', error);
                showToast('分享链接无效或已损坏', 'error');
            }
        }
        
        // 切换设置面板显示/隐藏
        function toggleSettingsPanel() {
            settingsPanel.classList.toggle('show');
            if (settingsPanel.classList.contains('show')) {
                loadSettings();
            }
        }
        
        // 加载设置
        function loadSettings() {
            try {
                const stored = localStorage.getItem(SETTINGS_STORAGE_KEY);
                if (stored) {
                    const settings = JSON.parse(stored);
                    
                    // 应用设置
                    if (settings.shareBaseUrl) {
                        shareBaseUrl = settings.shareBaseUrl;
                        shareBaseUrlInput.value = settings.shareBaseUrl;
                    }
                    
                    if (settings.autoSaveInterval) {
                        autoSaveInterval = settings.autoSaveInterval;
                        autoSaveIntervalInput.value = settings.autoSaveInterval;
                    }
                    
                    if (settings.maxHistoryRecords) {
                        MAX_HISTORY_RECORDS = settings.maxHistoryRecords;
                        maxHistoryRecordsInput.value = settings.maxHistoryRecords;
                    }
                }
            } catch (error) {
                console.error('加载设置失败:', error);
                showToast('加载设置失败', 'error');
            }
        }
        
        // 保存设置到localStorage
        function saveSettings(settings) {
            try {
                const currentSettings = JSON.parse(localStorage.getItem(SETTINGS_STORAGE_KEY) || '{}');
                const updatedSettings = { ...currentSettings, ...settings };
                localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(updatedSettings));
                showToast('设置已保存', 'success');
                return true;
            } catch (error) {
                console.error('保存设置失败:', error);
                showToast('保存设置失败', 'error');
                return false;
            }
        }
        
        // 保存分享基础URL
        function saveShareBaseUrl() {
            const url = shareBaseUrlInput.value.trim();
            shareBaseUrl = url;
            saveSettings({ shareBaseUrl: url });
        }
        
        // 重置分享基础URL
        function resetShareBaseUrl() {
            shareBaseUrl = '';
            shareBaseUrlInput.value = '';
            saveSettings({ shareBaseUrl: '' });
        }
        
        // 保存自动保存间隔
        function saveAutoSaveInterval() {
            const interval = parseInt(autoSaveIntervalInput.value);
            if (isNaN(interval) || interval < 1 || interval > 600) {
                showToast('请输入1-600之间的数值', 'error');
                return;
            }
            autoSaveInterval = interval;
            saveSettings({ autoSaveInterval: interval });
        }
        
        // 保存最大历史记录数
        function saveMaxHistoryRecords() {
            const maxRecords = parseInt(maxHistoryRecordsInput.value);
            if (isNaN(maxRecords) || maxRecords < 1 || maxRecords > 50) {
                showToast('请输入1-50之间的数值', 'error');
                return;
            }
            MAX_HISTORY_RECORDS = maxRecords;
            saveSettings({ maxHistoryRecords: maxRecords });
            // 如果当前历史记录超过新的最大值，裁剪历史记录
            if (historyRecords.length > MAX_HISTORY_RECORDS) {
                historyRecords = historyRecords.slice(0, MAX_HISTORY_RECORDS);
                saveHistory();
            }
        }
        
        // 应用所有设置
        function applyAllSettings() {
            saveShareBaseUrl();
            saveAutoSaveInterval();
            saveMaxHistoryRecords();
            showToast('所有设置已应用', 'success');
        }
        
        // 自动生成在线可访问链接（使用新的分享管理器）
        async function generateOnlineLink() {
            const content = htmlEditor.value;
            if (!content.trim()) {
                showToast('请输入内容', 'error');
                return;
            }
            
            try {
                showToast('生成中...', 'success');
                
                // 使用新的分享管理器
                const result = await shareManager.share(content, {
                    title: 'HTML在线分享'
                });
                
                if (result.success) {
                    // 更新分享链接输入框
                    shareLink.value = result.url;
                    
                    // 自动复制链接到剪贴板
                    await navigator.clipboard.writeText(result.url);
                    showToast('链接已生成并复制', 'success');
                    
                    console.log(`分享成功，使用提供商: ${result.provider}`);
                    console.log('在线链接:', result.url);
                } else {
                    showToast(result.message || '分享失败', 'error');
                }
                
            } catch (error) {
                console.error('生成失败:', error);
                showToast('生成失败', 'error');
            }
        }
        
        // ==========================================
        // 全新在线分享系统 - ShareManager
        // ==========================================
        
        class ShareManager {
            constructor() {
                this.providers = [
                    new GitHubGistProvider(),
                    new VercelProvider(),
                    new FirebaseProvider(),
                    new DataUrlProvider()
                ];
                this.shareHistory = this.loadShareHistory();
            }
            
            // 加载分享历史
            loadShareHistory() {
                try {
                    const history = localStorage.getItem('shareHistory');
                    return history ? JSON.parse(history) : [];
                } catch (error) {
                    console.error('加载分享历史失败:', error);
                    return [];
                }
            }
            
            // 保存分享历史
            saveShareHistory() {
                try {
                    localStorage.setItem('shareHistory', JSON.stringify(this.shareHistory));
                } catch (error) {
                    console.error('保存分享历史失败:', error);
                }
            }
            
            // 添加到分享历史
            addToHistory(shareInfo) {
                const historyItem = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    provider: shareInfo.provider,
                    url: shareInfo.url,
                    title: shareInfo.title || '未命名分享',
                    size: shareInfo.content?.length || 0
                };
                
                this.shareHistory.unshift(historyItem);
                // 限制历史记录数量
                if (this.shareHistory.length > 50) {
                    this.shareHistory = this.shareHistory.slice(0, 50);
                }
                this.saveShareHistory();
            }
            
            // 主分享方法
            async share(content, options = {}) {
                const title = options.title || this.generateTitle(content);
                
                for (const provider of this.providers) {
                    try {
                        console.log(`尝试使用 ${provider.name} 分享...`);
                        const result = await provider.share(content, { title, ...options });
                        
                        if (result.success) {
                            this.addToHistory({
                                provider: provider.name,
                                url: result.url,
                                title,
                                content
                            });
                            
                            return {
                                success: true,
                                url: result.url,
                                provider: provider.name,
                                message: '分享成功'
                            };
                        }
                    } catch (error) {
                        console.error(`${provider.name} 分享失败:`, error);
                        continue;
                    }
                }
                
                return {
                    success: false,
                    message: '所有分享方式都失败了'
                };
            }
            
            // 生成标题
            generateTitle(content) {
                // 从内容中提取标题
                const titleMatch = content.match(/<title[^>]*>(.*?)<\/title>/i);
                if (titleMatch && titleMatch[1].trim()) {
                    return titleMatch[1].trim();
                }
                
                // 从h1标签提取
                const h1Match = content.match(/<h1[^>]*>(.*?)<\/h1>/i);
                if (h1Match && h1Match[1].trim()) {
                    return h1Match[1].trim();
                }
                
                // 默认标题
                return `HTML分享-${new Date().toLocaleDateString()}`;
            }
            
            // 获取分享历史
            getShareHistory() {
                return this.shareHistory;
            }
            
            // 删除分享历史项
            removeFromHistory(id) {
                this.shareHistory = this.shareHistory.filter(item => item.id !== id);
                this.saveShareHistory();
            }
            
            // 清空分享历史
            clearHistory() {
                this.shareHistory = [];
                this.saveShareHistory();
            }
        }
        
        // ==========================================
        // 分享服务提供商基类
        // ==========================================
        class ShareProvider {
            constructor(name) {
                this.name = name;
            }
            
            async share(content, options = {}) {
                throw new Error('子类必须实现share方法');
            }
            
            // 检查服务是否可用
            async isAvailable() {
                return true;
            }
            
            // 获取文件大小限制
            getSizeLimit() {
                return Infinity;
            }
        }
        
        // ==========================================
        // GitHub Gist 提供商
        // ==========================================
        class GitHubGistProvider extends ShareProvider {
            constructor() {
                super('GitHub Gist');
            }
            
            async share(content, options = {}) {
                const title = options.title || 'HTML分享';
                const fileName = `share-${Date.now()}.html`;
                
                try {
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            description: title,
                            public: true,
                            files: {
                                [fileName]: {
                                    content: content
                                }
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const rawUrl = data.files[fileName].raw_url;
                    
                    return {
                        success: true,
                        url: `https://htmlpreview.github.io/?${rawUrl}`,
                        rawUrl: rawUrl
                    };
                } catch (error) {
                    throw new Error(`GitHub Gist分享失败: ${error.message}`);
                }
            }
        }
        
        // ==========================================
        // Vercel 提供商
        // ==========================================
        class VercelProvider extends ShareProvider {
            constructor() {
                super('Vercel');
            }
            
            async share(content, options = {}) {
                const title = options.title || 'HTML分享';
                
                try {
                    // 使用Vercel的部署API
                    const deploymentData = {
                        name: `html-share-${Date.now()}`,
                        files: [
                            {
                                file: 'index.html',
                                data: content
                            }
                        ]
                    };
                    
                    // 注意：这需要Vercel的API令牌
                    // 这里使用一个公共的示例服务
                    const response = await fetch('https://api.vercel.com/v1/integrations/deploy-button', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: title,
                            files: {
                                'index.html': content
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    return {
                        success: true,
                        url: data.url || `https://${data.id}.vercel.app`
                    };
                } catch (error) {
                    // 如果Vercel失败，回退到简单的托管服务
                    return await this.fallbackShare(content, options);
                }
            }
            
            async fallbackShare(content, options) {
                try {
                    // 使用一个简化的托管服务
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: options.title || 'HTML分享',
                            public: true,
                            files: {
                                'index.html': {
                                    content: content
                                }
                            }
                        })
                    });
                    
                    const data = await response.json();
                    return {
                        success: true,
                        url: data.html_url,
                        rawUrl: data.files['index.html'].raw_url
                    };
                } catch (error) {
                    throw new Error(`Vercel分享失败: ${error.message}`);
                }
            }
        }
        
        // ==========================================
        // Firebase 提供商
        // ==========================================
        class FirebaseProvider extends ShareProvider {
            constructor() {
                super('Firebase');
            }
            
            async share(content, options = {}) {
                try {
                    // 使用Firebase Hosting的简化版本
                    // 这里使用GitHub作为后端存储
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: options.title || 'HTML分享',
                            public: true,
                            files: {
                                [`firebase-share-${Date.now()}.html`]: {
                                    content: content
                                }
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    return {
                        success: true,
                        url: data.html_url,
                        rawUrl: data.files[Object.keys(data.files)[0]].raw_url
                    };
                } catch (error) {
                    throw new Error(`Firebase分享失败: ${error.message}`);
                }
            }
        }
        
        // ==========================================
        // 数据URL 提供商（最终备选）
        // ==========================================
        class DataUrlProvider extends ShareProvider {
            constructor() {
                super('Data URL');
            }
            
            getSizeLimit() {
                return 2 * 1024 * 1024; // 2MB限制
            }
            
            async share(content, options = {}) {
                try {
                    const encodedContent = encodeURIComponent(content);
                    const dataUrl = `data:text/html;charset=utf-8,${encodedContent}`;
                    
                    // 检查大小限制
                    if (dataUrl.length > this.getSizeLimit()) {
                        throw new Error('内容太大，无法生成数据URL');
                    }
                    
                    return {
                        success: true,
                        url: dataUrl,
                        isDataUrl: true
                    };
                } catch (error) {
                    throw new Error(`数据URL生成失败: ${error.message}`);
                }
            }
        }
        
        // 创建全局分享管理器实例
        const shareManager = new ShareManager();

        // 分享历史管理函数
        function refreshShareHistory() {
            const history = shareManager.getShareHistory();
            const historyList = document.getElementById('shareHistoryList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p class="no-history">暂无分享历史</p>';
                return;
            }
            
            historyList.innerHTML = history.map(item => `
                <div class="share-history-item" data-id="${item.id}">
                    <div class="share-history-info">
                        <div class="share-history-title">${escapeHtml(item.title)}</div>
                        <div class="share-history-meta">
                            <span class="share-history-provider">${item.provider}</span>
                            <span>📅 ${formatDate(item.timestamp)}</span>
                            <span>📊 ${formatFileSize(item.size)}</span>
                        </div>
                    </div>
                    <div class="share-history-actions-item">
                        <button class="share-history-btn share-history-btn-copy" onclick="copyHistoryLink('${item.url}')" title="复制链接">
                            📋
                        </button>
                        <button class="share-history-btn share-history-btn-open" onclick="openHistoryLink('${item.url}')" title="打开链接">
                            🔗
                        </button>
                        <button class="share-history-btn share-history-btn-delete" onclick="deleteHistoryItem('${item.id}')" title="删除">
                            🗑️
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function copyHistoryLink(url) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    showToast('链接已复制到剪贴板', 'success');
                }).catch(() => {
                    fallbackCopyHistoryLink(url);
                });
            } else {
                fallbackCopyHistoryLink(url);
            }
        }
        
        function fallbackCopyHistoryLink(url) {
            const textArea = document.createElement('textarea');
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('链接已复制到剪贴板', 'success');
            } catch (err) {
                showToast('复制失败，请手动复制', 'error');
            }
            document.body.removeChild(textArea);
        }
        
        function openHistoryLink(url) {
            if (url) {
                window.open(url, '_blank');
                showToast('链接已在新窗口打开', 'success');
            } else {
                showToast('链接无效', 'error');
            }
        }
        
        function deleteHistoryItem(id) {
            if (confirm('确定要删除这条分享历史吗？')) {
                shareManager.removeFromHistory(parseInt(id));
                refreshShareHistory();
                showToast('分享历史已删除', 'success');
            }
        }
        
        function clearShareHistory() {
            if (confirm('确定要清空所有分享历史吗？此操作不可恢复。')) {
                shareManager.clearHistory();
                refreshShareHistory();
                showToast('分享历史已清空', 'success');
            }
        }
        
        // 工具函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // 小于1分钟
            if (diff < 60000) {
                return '刚刚';
            }
            // 小于1小时
            if (diff < 3600000) {
                return Math.floor(diff / 60000) + '分钟前';
            }
            // 小于1天
            if (diff < 86400000) {
                return Math.floor(diff / 3600000) + '小时前';
            }
            // 小于7天
            if (diff < 604800000) {
                return Math.floor(diff / 86400000) + '天前';
            }
            
            // 超过7天，显示具体日期
            return date.toLocaleDateString('zh-CN');
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // iOS Safari/Edge 兼容性：增强触摸事件处理
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            // 为所有按钮添加触摸事件支持
            [clearBtn, pasteBtn, downloadBtn, fullscreenBtn, printBtn, openBtn].forEach(function(btn) {
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    this.style.opacity = '0.7';
                    this.style.transform = 'scale(0.98)';
                });
                
                btn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.style.opacity = '';
                    this.style.transform = '';
                    
                    // 延迟执行点击功能，确保触摸事件完全处理
                    setTimeout(() => {
                        if (this.id === 'clearBtn') {
                            clearEditor();
                        } else if (this.id === 'pasteBtn') {
                            pasteFromClipboard();
                        } else if (this.id === 'downloadBtn') {
                            downloadHTML();
                        } else if (this.id === 'fullscreenBtn') {
                            toggleFullscreenPreview();
                        } else if (this.id === 'printBtn') {
                            printPreview();
                        } else if (this.id === 'openBtn') {
                            openLocalFile();
                        }
                    }, 50);
                });
                
                btn.addEventListener('touchcancel', function(e) {
                    this.style.opacity = '';
                    this.style.transform = '';
                });
            });
            
            // 防止双击缩放
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // 防止页面缩放
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
        }
    </script>
</body>
</html>